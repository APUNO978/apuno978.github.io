<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="USA 2025"/>
<title>USA 2025 Adventure</title>
<!-- Leaflet.js for Interactive Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
:root{
--primary: #FF385C; --primary-light: #FFE8ED; --secondary: #00A699; --success: #34C759;
--text-primary: #1D1D1F; --text-secondary: #6E6E73; --text-tertiary: #8E8E93;
--bg-primary: #FFFFFF; --bg-secondary: #F2F2F7; --surface: #FFFFFF;
--separator: rgba(60,60,67,0.12); --link: #007AFF;
--shadow-sm: 0 1px 3px rgba(0,0,0,0.04); --shadow-md: 0 4px 12px rgba(0,0,0,0.08); --shadow-lg: 0 8px 32px rgba(0,0,0,0.12); --shadow-xl: 0 16px 64px rgba(0,0,0,0.16);
--radius-lg: 16px; --radius-xl: 20px; --radius-2xl: 24px;
--spring: cubic-bezier(0.175, 0.885, 0.32, 1.275); --ease-ios: cubic-bezier(0.25, 0.1, 0.25, 1);
--safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
}
/* Enable smooth scrolling for JS and anchor links */
html {
  scroll-behavior: smooth;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{
font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Helvetica Neue",Arial,sans-serif;
background:var(--bg-secondary); color:var(--text-primary);
-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
overflow-x:hidden;
/* Add padding for top and new bottom nav */
padding-top:var(--safe-top);
padding-bottom: calc(65px + var(--safe-bottom));
}

/* ========== NEW: Main App Structure ========== */
.app-header {
    background: rgba(242, 242, 247, 0.8);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-bottom: 0.5px solid var(--separator);
    padding: 12px 20px;
    padding-top: calc(var(--safe-top) + 12px);
    position: sticky;
    top: 0;
    z-index: 1000;
}
.app-header-title {
    font-size: 28px;
    font-weight: 800;
    text-align: center;
}
.tab-content {
    display: none; /* Hidden by default */
    padding: 0; /* Let sections inside handle their own padding */
}
.tab-content.active {
    display: block; /* Shown when active */
}
.content-grid{display:grid; grid-template-columns: 1fr; gap: 16px; max-width: 1200px; margin: 0 auto; padding: 16px;}
@media (min-width: 1024px) {
.content-grid { grid-template-columns: 2fr 1fr; }
.grid-span-2 { grid-column: span 2; }
}
.content-section{background:var(--bg-primary); border-radius:var(--radius-xl); overflow:hidden; box-shadow:var(--shadow-md);}
.section-header{padding:24px 20px 16px; border-bottom:1px solid var(--separator);}
.section-title{font-size:24px; font-weight:700; color:var(--text-primary); margin-bottom:4px;}
.section-subtitle{font-size:16px; color:var(--text-secondary);}
.section-content{padding:20px;}

/* ========== NEW: Bottom Tab Navigation ========== */
.bottom-tab-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: calc(65px + var(--safe-bottom));
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-top: 0.5px solid var(--separator);
    display: flex;
    justify-content: space-around;
    padding-bottom: var(--safe-bottom);
    z-index: 2000;
}
.tab-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--text-tertiary);
    font-size: 10px;
    font-weight: 500;
    cursor: pointer;
    flex-grow: 1;
    transition: all 0.2s ease;
}
.tab-btn .icon {
    font-size: 24px;
    margin-bottom: 2px;
    line-height: 1;
}
.tab-btn.active {
    color: var(--primary);
}
.tab-btn:hover:not(.active) {
    color: var(--text-primary);
}

/* ========== NEW: "Today" Tab Specific Styles ========== */
.today-view .hero-card {
    background: var(--bg-primary);
    border-radius: var(--radius-xl);
    padding: 24px;
    margin: 16px;
    box-shadow: var(--shadow-lg);
    text-align: center;
}
.hero-card .hero-title {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 8px;
}
.hero-card .hero-subtitle {
    font-size: 16px;
    color: var(--text-secondary);
}
.countdown-container {
    display:flex; justify-content:center; gap:12px; margin-top:24px; flex-wrap:nowrap;
}
.countdown-card {
    background:var(--bg-secondary); border:1px solid var(--separator); border-radius:var(--radius-lg); padding:16px 12px; min-width:72px; box-shadow:var(--shadow-sm);
}
.countdown-value{font-size:28px; font-weight:800; color:var(--primary); line-height:1; display:block; font-variant-numeric:tabular-nums;}
.countdown-label{font-size:12px; font-weight:600; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.5px; margin-top:4px;}

.today-view .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 12px;
    padding: 0;
}
.quick-action-card {
    display: flex;
    flex-direction: column; /* Changed for icon top, label bottom */
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    padding: 20px;
    text-decoration: none;
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
}
.quick-action-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}
.quick-action-card .icon { font-size: 28px; margin: 0;}
.quick-action-card .label { font-size: 14px; font-weight: 600; text-align: center; }
.quick-action-card.primary {
    background: var(--primary);
    color: white;
}
/* Original Hero (pre-trip countdown) */
.hero{background:var(--bg-primary); padding:32px 20px 40px; text-align:center;}
.hero-title{font-size:clamp(32px, 8vw, 48px); font-weight:800; letter-spacing:-0.02em; line-height:1.1; margin-bottom:8px;}
.hero-subtitle{font-size:18px; font-weight:500; color:var(--text-secondary); margin-bottom:24px;}


/* ========== Road Trip Map (Final Polished Layout) ========== */
.route66{
margin:22px 0;
border:1px solid var(--separator);
border-radius:20px;
background:linear-gradient(90deg, rgba(255,215,0,.08), rgba(88,86,214,.08)), #f6f7fb;
box-shadow:0 12px 28px rgba(16,24,40,.08);
padding:14px 0 18px;
position:relative;
}
.route66 .section-title{margin-bottom:12px; padding: 0 24px;}
.route66__track{
position: relative;
min-height: 120px;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
scrollbar-width: none;
}
.route66__track::-webkit-scrollbar{ display: none; }
.route66__content-scroller {
position: relative;
width: 150%;
min-height: 100px;
padding: 0 24px;
}
.route66__road{
position:absolute;left:24px;right:24px;bottom:5px;
height:3px;border-radius:2px;
background:linear-gradient(90deg, var(--primary), var(--secondary));
box-shadow:0 2px 8px rgba(0,0,0,.08);z-index:1;
}
.route66__stops{
display:grid;grid-template-columns:repeat(6,1fr);
gap:clamp(6px,1.8vw,16px);
position:relative;z-index:2;
height: 100%;
}
.route66__stop{
display: flex;
flex-direction: column;
align-items:center;
text-align:center;
justify-content: flex-end;
background:none; border:0; padding:0; cursor: pointer;
}
.route66__date{ font-size:clamp(10px,1.4vw,12px);color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.08em; margin-bottom: 6px;}
.route66__icon{ font-size:clamp(20px,3vw,28px);line-height:1; margin-bottom: 4px; }
.route66__label{ font-size:clamp(12px,1.9vw,14px);font-weight:800;line-height:1.15; margin-bottom: 8px; color: var(--primary); }
.route66__dot{ width:12px;height:12px;border-radius:50%;background:#fff;border:3px solid var(--primary); }
.route66__progress{
position:absolute;bottom:0px;
left: 24px;
width:12px;height:12px;border-radius:50%;
background:var(--success);box-shadow:0 0 0 4px rgba(52,199,89,.16);
z-index:3;
transition: left 1s linear;
}
.timeline-update {
font-size: 14px;
color: var(--text-secondary);
margin-top: 12px;
display: flex;
justify-content: space-between;
align-items: center;
padding: 0 24px;
}
.map-view-btn {
    font-size: 14px;
    font-weight: 600;
    color: var(--link);
    background: none;
    border: none;
    cursor: pointer;
}
@media (max-width: 400px) {
    .map-view-btn { font-size: 12px; }
}


@media (max-width:768px){
.route66__content-scroller { width: 200%; }
.route66__label { font-size: 11px; }
.route66__icon { font-size: 20px; }
}
/* ========== Trip Planner (Carousel) ========== */
.trip-planner { padding: 24px; }
.planner-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.planner-header h2 { font-size: 22px; font-weight: 700; margin-bottom: 0; }
.planner-dots { display: flex; gap: 6px; }
.dot { width: 8px; height: 8px; border-radius: 50%; background: var(--separator); transition: all 0.3s ease; cursor: pointer; }
.dot.active { background: var(--link); transform: scale(1.2); }
.tip-carousel { overflow: hidden; cursor: grab; }
.tip-track { display: flex; transition: transform 0.5s var(--ease-ios); }
.tip-slide { flex-shrink: 0; width: 100%; display: flex; align-items: center; gap: 16px; padding-bottom: 4px; }
.tip-icon { font-size: 28px; background: var(--primary-light); color: var(--primary); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.tip-text h4 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.tip-text p { font-size: 14px; color: var(--text-secondary); line-height: 1.4; }
/* ========== Currency Converter ========== */
.currency-converter { padding: 24px; }
.currency-converter h2 { font-size: 22px; font-weight: 700; margin-bottom: 4px; display:flex; align-items:center; gap: 8px;}
.currency-rate { font-size: 28px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px; }
.currency-rate-sub { font-size: 12px; color: var(--text-tertiary); margin-bottom: 16px; }
.currency-inputs { display: flex; gap: 12px; }
.currency-inputs input { flex: 1; padding: 12px; font-size: 16px; border-radius: 12px; border: 1px solid var(--separator); background: var(--bg-secondary); }
.quick-convert-buttons { display: flex; gap: 8px; margin-top: 12px; }
.quick-convert-btn { flex: 1; background: var(--bg-secondary); border: 1px solid var(--separator); padding: 8px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
.quick-convert-btn:hover { border-color: var(--link); color: var(--link); }
.conversion-result { margin-top: 16px; background: var(--primary-light); color: var(--primary); font-weight: 600; padding: 12px; border-radius: 12px; text-align: center; font-size: 18px; visibility: hidden; opacity: 0; transition: all 0.3s ease; }
.conversion-result.visible { visibility: visible; opacity: 1; }
.currency-chart { height: 60px; margin: 20px 0; }
.currency-chart svg { width: 100%; height: 100%; }
.currency-chart .sparkline { stroke: var(--link); stroke-width: 2.5; fill: none; stroke-linecap: round; stroke-linejoin: round; animation: draw-chart 1s ease-out; }
@keyframes draw-chart { from { stroke-dasharray: 1000; stroke-dashoffset: 1000; } to { stroke-dasharray: 1000; stroke-dashoffset: 0; } }
.action-btn { width: 100%; padding: 16px; font-size: 16px; font-weight: 600; color: #fff; background: var(--link); border: none; border-radius: 12px; cursor: pointer; transition: background 0.2s ease; }
.action-btn:hover { background: #0056b3; }
/* ========== Destinations Hub (Main Component) ========== */
.tabs{display:flex;gap:12px;margin-bottom:24px;overflow-x:auto;flex-wrap:nowrap;padding:4px 20px;margin-left:-20px;margin-right:-20px; scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{padding:8px 18px;background:var(--surface);border:1px solid var(--separator);border-radius:30px;font-weight:600;cursor:pointer;transition:all .3s var(--ease-ios); white-space:nowrap; flex-shrink:0; font-size: 15px;}
.tab.active{background:var(--primary);color:#fff;border-color:var(--primary);transform:translateY(-2px);box-shadow:0 8px 16px rgba(255,56,92,.25)}
.tab:hover:not(.active){transform:translateY(-1px);box-shadow:var(--shadow-md)}
.main-card{background:var(--surface);border-radius:var(--radius-xl);overflow:hidden;box-shadow:var(--shadow-lg);display:flex;transition:opacity .4s var(--ease-ios), transform .4s var(--ease-ios);opacity:0;transform:translateY(20px)}
.main-card.visible{opacity:1;transform:translateY(0)}
.hero-image{flex:1;min-height:500px;background-size:cover;background-position:center;position:relative;display:flex;flex-direction:column;justify-content:flex-end;padding:32px;color:#fff}
.hero-image::after{content:"";position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.7) 0%,rgba(0,0,0,0) 55%)}
.hero-image-title{position:relative;z-index:1;font-size:36px;font-weight:800;line-height:1.2}
.hero-area{position:relative;z-index:1;font-size:18px;font-weight:500;opacity:.95;margin-top:4px}
.content-column{flex:0 0 350px;padding:24px;display:flex;flex-direction:column;gap:24px;max-height:500px;overflow-y:auto; background:var(--bg-secondary);}
.info-item{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--separator);font-size:16px}
.info-item:last-child{border-bottom:none}
.widget{background:var(--surface);border:1px solid var(--separator);box-shadow:var(--shadow-sm);border-radius:var(--radius-lg);padding:20px}
.widget h3{font-size:18px;font-weight:700;margin-bottom:12px;color:var(--text-primary)}
.widget-list{display:grid;gap:12px}
.widget-item{display:flex;gap:14px;padding:12px;border:1px solid var(--separator);border-radius:var(--radius-lg);align-items:center;transition:transform .15s var(--ease-ios),background .15s var(--ease-ios)}
.widget-item:hover{transform:translateY(-2px);background:var(--primary-light)}
.widget-icon{font-size:24px;width:30px;text-align:center}
.widget-text h4{font-size:16px;font-weight:600}
.widget-text p{font-size:14px;color:var(--text-secondary)}
.widget-item.a{cursor:pointer;text-decoration:none;color:inherit}
.weather-main{display:flex;align-items:center;gap:16px;margin-bottom:12px}
.weather-icon{font-size:46px;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.weather-temp{font-size:40px;font-weight:800}
.weather-desc{font-size:15px;color:var(--text-secondary)}
.weather-explainer { font-size: 12px; color: var(--text-tertiary); margin-top: -8px; margin-bottom: 8px;}
/* ========== Moments Section ========== */
.moments-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));gap:16px;}
.moment-card{background:var(--surface);border:1px solid var(--separator);border-radius:var(--radius-lg);padding:20px;transition:all 0.2s var(--ease-ios);cursor:pointer;}
.moment-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg);border-color:var(--primary);}
.moment-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.moment-icon{font-size:32px;}
.moment-title{font-size:18px;font-weight:600;}
.moment-description{font-size:14px;color:var(--text-secondary);line-height:1.5;}

/* ========== Journey Hub Styles ========== */
.flights-list { display: grid; gap: 16px; }
.drive-card, .flight-summary-card {
    background:var(--surface);
    border:1px solid var(--separator);
    border-radius:var(--radius-lg);
    overflow:hidden;
    box-shadow:var(--shadow-sm);
    transition: all 0.4s var(--ease-ios);
}
.drive-card { border-left: 4px solid var(--secondary); }
.flight-summary-card { cursor: pointer; }
.flight-summary-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

.drive-card-content, .flight-summary-content { padding:16px 20px; }
.flight-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.flight-route{font-size:20px;font-weight:700;}
.flight-date{font-size:14px;color:var(--text-secondary);}
.flight-details{display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:16px; margin-top: 16px; border-top: 1px solid var(--separator); padding-top: 16px;}
.detail-label{font-size:12px;color:var(--text-tertiary);text-transform:uppercase;margin-bottom:4px;}
.detail-value{font-size:16px;font-weight:600;}
.drive-fact {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--separator);
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
}
.drive-fact::before { content: '💡'; margin-right: 8px; font-size: 16px; }

.flight-summary-card.get-ready{border-color:var(--primary); box-shadow:var(--shadow-lg);}
.flight-summary-card.travel-day { border-color:var(--secondary); box-shadow:var(--shadow-xl);}
.flight-summary-card.archived{opacity:0.65; box-shadow:none; border-style: dashed;}
.journey-countdown{text-align:center;padding:12px 0 24px;}
.countdown-title{font-size:12px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-tertiary);margin-bottom:8px;}
.countdown-time{font-size:32px;font-weight:800;color:var(--secondary);font-variant-numeric:tabular-nums;}
.journey-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;}
.journey-btn{background:var(--bg-secondary);color:var(--text-primary);text-decoration:none;padding:14px;border-radius:var(--radius-lg);font-size:14px;font-weight:600;text-align:center;transition:all 0.2s ease;}
.journey-btn:hover{background:var(--primary-light);color:var(--primary);}
.journey-btn.primary{background:var(--secondary);color:white;}
.journey-btn.primary:hover{background:#007A6D;}
.handoff-welcome{text-align:center;padding:16px 0;}
.handoff-title{font-size:24px; font-weight:700; margin-bottom:4px;}
.handoff-subtitle{font-size:14px; color: var(--text-secondary);}
.handoff-address{background:var(--bg-secondary);border-radius:var(--radius-lg);padding:16px;margin:20px 0;text-align:center;}
.handoff-address strong{display:block;margin-bottom:6px;font-size:16px;}

/* ========== Boarding Pass Modal ========== */
.boarding-pass-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    z-index: 5000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s var(--ease-ios);
}
.boarding-pass-overlay.show { opacity: 1; pointer-events: auto; }

.boarding-pass {
  position: relative;
  width: 90vw;
  max-width: 350px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 5px 30px rgba(0, 0, 0, .2);
  overflow: hidden;
  text-transform: uppercase;
  color: #363c44;
  font-size: 14px;
  font-family: 'Roboto', sans-serif;
  transform: scale(0.95);
  transition: transform 0.3s var(--spring);
}
.boarding-pass-overlay.show .boarding-pass { transform: scale(1); }

.boarding-pass small {
    display: block;
    font-size: 11px;
    color: #A2A9B3;
    margin-bottom: 2px;
}

.boarding-pass strong {
    font-size: 15px;
    display: block;
}

/* Header */
.boarding-pass header {
    background: linear-gradient(to bottom, #36475f, #2c394f);
    padding: 12px 20px;
    height: 53px;
}

.boarding-pass header .logo {
    float: left;
    height: 31px;
    font-size: 20px;
    font-weight: bold;
    color: #fff;
    line-height: 31px;
}

.boarding-pass header .flight {
    float: right;
    color: #fff;
    text-align: right;
}
.boarding-pass header .flight small {
    font-size: 8px;
    margin-bottom: 2px;
    opacity: 0.8;
}
.boarding-pass header .flight strong {
    font-size: 18px;
}

/* Cities */
.boarding-pass .cities {
    position: relative;
    border-bottom: 1px dotted #e2e2e2;
}
.boarding-pass .cities::after {
    content: '';
    display: table;
    clear: both;
}
.boarding-pass .cities .city {
    padding: 20px 18px;
    float: left;
}
.boarding-pass .cities .city:nth-child(2) {
    float: right;
}
.boarding-pass .cities .city strong {
    font-size: 40px;
    font-weight: 300;
    line-height: 1;
}
.boarding-pass .cities .city small {
    margin-bottom: 0px;
    margin-left: 3px;
}
.boarding-pass .cities .airplane {
    position: absolute;
    width: 30px;
    height: 25px;
    top: 50%;
    left: 30%;
    opacity: 0;
    transform: translate(-50%, -50%);
    animation: move 3s infinite;
}
@keyframes move {
    30% { opacity: 1; }
    40% { left: 50%; }
    80% { opacity: 0; }
    100% { left: 70%; opacity: 0;}
}

/* Infos */
.boarding-pass .infos {
    display: flex;
    border-top: 1px solid #99D298;
}
.boarding-pass .infos .places,
.boarding-pass .infos .times {
    width: 50%;
}
.boarding-pass .infos .places::after,
.boarding-pass .infos .times::after {
    content: '';
    display: table;
    clear: both;
}
.boarding-pass .infos .times strong {
    transform: scale(0.9);
    transform-origin: left bottom;
}
.boarding-pass .infos .places {
    background: #ECECEC;
    border-right: 1px solid #99D298;
}
.boarding-pass .infos .places small { color: #97A1AD; }
.boarding-pass .infos .places strong { color: #239422; }
.boarding-pass .infos .box {
    padding: 10px 15px;
    width: 50%; /* Adjusted for better fit */
    float: left;
}
.boarding-pass .infos .box small { font-size: 10px; }

/* Strap */
.boarding-pass .strap {
    clear: both;
    position: relative;
    border-top: 1px solid #99D298;
}
.boarding-pass .strap::after {
    content: '';
    display: table;
    clear: both;
}
.boarding-pass .strap .box {
    padding: 20px 20px;
}
.boarding-pass .strap .box div {
    margin-bottom: 15px;
}
.boarding-pass .strap .box div small { font-size: 10px; }
.boarding-pass .strap .box div strong { font-size: 13px; }
.boarding-pass .strap .box sup {
    font-size: 8px;
    position: relative;
    top: -5px;
}
.boarding-pass .strap .qrcode {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 80px;
    height: 80px;
}


/* ========== Vegas Birthday Section ========== */
.vegas-birthday {
position: relative;
border-radius: var(--radius-xl);
overflow: hidden;
background: #0A0A0F;
color: #FFFFFF;
padding: 32px 20px;
text-align: center;
box-shadow: var(--shadow-md);
}
.vegas-backdrop {
position: absolute;
inset: 0;
z-index: 1;
background:
radial-gradient(ellipse at 20% 0%, #9D00FF 0%, transparent 40%),
radial-gradient(ellipse at 80% 100%, #FF1493 0%, transparent 40%),
#0A0A0F;
animation: vegasGlow 10s ease-in-out infinite alternate;
}
@keyframes vegasGlow { 0% { opacity: 0.7; } 100% { opacity: 1; } }
.vegas-content { position: relative; z-index: 10; }
.neon-title {
font-size: clamp(36px, 10vw, 64px);
font-weight: 900;
line-height: 1;
background: linear-gradient(45deg, #FFD700, #FF1493, #00F5FF);
background-size: 200% auto;
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
filter: drop-shadow(0 0 15px #FF1493);
animation: gradientMove 3s linear infinite, neonPulse 2s ease-in-out infinite;
margin-bottom: 8px;
}
@keyframes gradientMove { to { background-position: 200% center; } }
@keyframes neonPulse { 50% { filter: drop-shadow(0 0 25px #FF1493); } }
.vegas-subtitle { font-size: 16px; color: rgba(255, 255, 255, 0.8); margin-bottom: 24px; }
.jackpot-btn {
background: linear-gradient(135deg, #FFD700, #FF6B35);
color: #0A0A0F;
border: none;
border-radius: var(--radius-lg);
padding: 18px 32px;
font-size: 16px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s var(--spring);
box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
margin-top: 24px;
}
.jackpot-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 12px 40px rgba(255, 215, 0, 0.6); }
#vegasConfettiCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
.slot-machine-container { max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.5s ease-out, opacity 0.5s ease-out, margin-top 0.5s ease-out; }
.slot-machine-container.visible { max-height: 150px; opacity: 1; margin-top: 20px; }
.slot-machine { display: flex; justify-content: center; gap: 12px; padding: 10px; background: linear-gradient(180deg, #1F1F2E, #0A0A0F); border-radius: 16px; border: 2px solid #FFD700; box-shadow: inset 0 0 15px rgba(255, 215, 0, 0.2); }
.slot-reel { width: 80px; height: 100px; background: #151521; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); overflow: hidden; position: relative; }
.reel-strip span { display: flex; align-items: center; justify-content: center; height: 100px; font-size: 50px; color: #fff; }
.vegas-toast { position: fixed; top: 20px; left: 50%; transform: translate(-50%, -120px); background: rgba(20, 20, 35, 0.9); backdrop-filter: blur(10px); border: 1px solid #FFD700; border-radius: var(--radius-lg); padding: 16px 24px; display: flex; align-items: center; gap: 12px; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.4); color: #fff; transition: transform 0.5s var(--spring); }
.vegas-toast.show { transform: translate(-50%, 0); }

/* ========== Live Travel Intelligence ========== */
.intelligence-list { display: grid; gap: 16px; }
.intelligence-card {
    display: flex;
    gap: 16px;
    background: var(--surface);
    padding: 16px;
    border-radius: var(--radius-lg);
    border-left: 4px solid var(--link);
    box-shadow: var(--shadow-sm);
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
}
.intelligence-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}
.intelligence-card.alert { border-color: #FF9500; }
.intelligence-card.critical { border-color: var(--primary); }
.intelligence-card.briefing {
    border-color: var(--secondary);
    background: linear-gradient(45deg, rgba(0, 166, 153, 0.05), transparent);
}
.intelligence-card .icon { font-size: 24px; margin-top: 2px; }
.intelligence-card .content h4 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.intelligence-card .content p { font-size: 14px; color: var(--text-secondary); line-height: 1.4; }
.intelligence-card .content p strong { font-weight: 600; color: var(--text-primary); }
.intelligence-card .meta { font-size: 12px; color: var(--text-tertiary); margin-top: 8px; }
.intelligence-list .placeholder {
    text-align: center;
    padding: 20px;
    color: var(--text-tertiary);
    font-size: 14px;
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
}


/* ========== OVERLAYS & MODALS ========== */
/* Map Modal */
.map-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    z-index: 4000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s var(--ease-ios);
}
.map-modal-overlay.show { opacity: 1; pointer-events: auto; }
.map-modal-content {
    background: var(--surface);
    width: 90vw;
    height: 85vh;
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: scale(0.95);
    transition: transform 0.3s var(--spring);
}
.map-modal-overlay.show .map-modal-content { transform: scale(1); }
#map-container { flex-grow: 1; }
.map-modal-close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(0,0,0,0.4);
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    z-index: 1001; /* Above map tiles */
}
/* Leaflet attribution control style */
.leaflet-control-attribution { font-size: 10px !important; }

.wx-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);backdrop-filter:blur(10px);opacity:0;pointer-events:none;transition:opacity .35s ease;z-index:2200;display:flex;align-items:center;justify-content:center}
.wx-overlay.show{opacity:1;pointer-events:auto}
.wx-sheet{position:relative;overflow:hidden;color:#fff;border-radius:var(--radius-2xl);box-shadow:0 30px 80px rgba(0,0,0,.4);width:min(500px,94vw);max-height:min(86vh,900px);display:flex;flex-direction:column; transform:scale(0.95); transition:transform 0.3s var(--spring);}
.wx-overlay.show .wx-sheet{transform:scale(1);}
.wx-sunny{background:linear-gradient(135deg,#f6d365,#fda085)}
.wx-cloudy{background:linear-gradient(135deg,#7f8fa6,#718093)}
.wx-rainy{background:linear-gradient(135deg,#74b9ff,#0984e3)}
.wx-close{position:absolute;top:12px;right:12px;border:none;background:rgba(255,255,255,.15);backdrop-filter:blur(6px);color:#fff;border-radius:50%;width:32px;height:32px;cursor:pointer;z-index:10; font-size:16px;}
.wx-top{padding:22px;position:relative}
.weather-animation{position:absolute;inset:0;pointer-events:none}
.rain-drop{position:absolute;width:2px;height:20px;background:rgba(255,255,255,0.6);border-radius:1px;animation:rain 1s linear infinite}
@keyframes rain{0%{transform:translateY(-10px);opacity:0}50%{opacity:1}100%{transform:translateY(60px);opacity:0}}
.wx-city{font-weight:800;letter-spacing:.3px}
.wx-meta{display:flex;align-items:baseline;gap:10px;margin-top:6px}
.wx-temp-lg{font-size:56px;font-weight:900;line-height:1}
.wx-desc-lg{opacity:.95}
.wx-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.wx-chip{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:10px 12px;font-size:14px;display:flex;justify-content:space-between}
.wx-body{background:rgba(0,0,0,.12);backdrop-filter:blur(4px);padding:14px;overflow:auto}
.wx-body h4{font-size:16px;font-weight:600;margin-bottom:8px;opacity:0.9;}
.wx-row{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px; scrollbar-width:none;}
.wx-row::-webkit-scrollbar{display:none}
.wx-hour{min-width:72px;text-align:center;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:10px}
.wx-hour .t{font-weight:800}
.wx-days{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.wx-day{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:10px;text-align:center}
.wx-day .hi{font-weight:800}
.wx-day .lo{opacity:.85}

.concierge-btn{position:fixed;bottom:calc(var(--safe-bottom) + 85px);right:20px;background:var(--primary);color:#fff;border:none;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow-xl);transition:all .3s var(--spring);z-index:1000}
.concierge-btn:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 12px 40px rgba(255,56,92,.4)}
.concierge-btn .icon{font-size:24px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .4s ease;z-index:2000}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal{background:var(--surface);border-radius:var(--radius-xl) var(--radius-xl) 0 0;padding:16px 20px calc(var(--safe-bottom) + 20px);width:100%;max-width:500px;transform:translateY(100%);transition:transform .4s var(--spring)}
.modal-overlay.show .modal{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--separator);border-radius:2px;margin:0 auto 16px}
.modal-title{font-size:20px;font-weight:600;text-align:center;margin-bottom:16px;}
.quick-actions{display:grid;grid-template-columns:repeat(3, 1fr);gap:14px;}
.quick-action{display:flex;flex-direction:column;align-items:center;padding:16px;background:var(--bg-secondary);border-radius:var(--radius-lg);text-decoration:none;color:inherit;transition:transform .2s var(--ease-ios), background .2s var(--ease-ios)}
.quick-action:hover{transform:translateY(-4px);background:var(--primary-light)}
.quick-action .icon{font-size:28px;margin-bottom:10px}
.quick-action .label{font-weight:600;font-size:14px;text-align:center}

.modal-overlay-custom{position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(10px); z-index:2100; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity 0.3s var(--ease-ios);}
.modal-overlay-custom.show{opacity:1; pointer-events:auto;}
.modal-content-custom{background:var(--surface); border-radius:var(--radius-xl); max-width:600px; width:90%; max-height:85vh; overflow:hidden; display:flex; flex-direction:column; transform:scale(0.95); transition:transform 0.3s var(--spring);}
.modal-overlay-custom.show .modal-content-custom{transform:scale(1);}
.modal-header-custom{padding:16px 20px; border-bottom:1px solid var(--separator); display:flex; justify-content:space-between; align-items:center;}
.modal-title-custom{font-size:20px; font-weight:600;}
.modal-close-btn{background:var(--bg-secondary); border:0; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center;}
.modal-body-custom{padding:20px; overflow-y:auto;}
.modal-list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:var(--radius-lg);margin-bottom:8px;}
.modal-item-text strong{display:block;font-size:16px;font-weight:600;}
.modal-item-text span{font-size:14px;color:var(--text-secondary);}
.modal-item-action{background:var(--primary);color:white;text-decoration:none;padding:8px 16px;border-radius:var(--radius-lg);font-size:14px;font-weight:600;}
.live-tip{background:var(--primary-light); border-left: 3px solid var(--primary); padding:12px; border-radius: 8px; margin-top:8px;}
/* ========== MOBILE & RESPONSIVE STYLES ========== */

@media (max-width: 800px){
  .main-card{flex-direction:column}
  .content-column{max-height:none}
  .hero-image{min-height:420px}

  .content-column .widget-list {
    display: flex;
    overflow-x: auto;
    gap: 10px;
    padding-bottom: 8px;
    margin: 0 -20px;
    padding-left: 20px;
    padding-right: 20px;
    scrollbar-width: none;
  }
  .content-column .widget-list::-webkit-scrollbar { display: none; }

  .content-column .widget-item {
    flex-shrink: 0;
    width: 220px;
  }
}

@media (max-width: 768px) {
  .moments-grid {
    display: flex;
    overflow-x: auto;
    flex-wrap: nowrap;
    gap: 12px;
    margin: 0;
    padding: 4px 0;
    scrollbar-width: none;
    scroll-snap-type: x mandatory;
  }
  .moments-grid::-webkit-scrollbar { display: none; }
  .moments-grid .moment-card {
    flex-shrink: 0;
    width: 68vw;
    max-width: 260px;
    scroll-snap-align: start;
  }
  .moments-grid::after {
      content: '';
      display: block;
      flex-shrink: 0;
      width: 8px;
  }
}

@media (max-width: 420px) {
    .hero-subtitle {
        font-size: 16px;
    }
}

/* ========== FIX: Countdown on small screens ========== */
@media (max-width: 380px) {
  .countdown-container {
    gap: 8px;
    flex-wrap: nowrap;
  }
  .countdown-card {
    padding: 12px 6px;
    min-width: 0;
    flex: 1;
  }
  .countdown-value {
    font-size: 22px;
  }
  .countdown-label {
    font-size: 10px;
  }
}

.animate-on-scroll{opacity:0;transform:translateY(20px);transition:all 0.6s var(--ease-ios);}
.animate-on-scroll.visible{opacity:1;transform:translateY(0);}
</style>
</head>
<body>

<header class="app-header">
    <h1 class="app-header-title" id="app-header-title">Today</h1>
</header>

<main>
    <!-- "Today" Tab Content -->
    <div id="tab-today" class="tab-content active">
        <div class="today-view" id="today-view-content">
            <!-- ADDED A PLACEHOLDER FOR BETTER UX -->
            <div class="hero-card"><p class="hero-subtitle">Loading your daily dashboard...</p></div>
        </div>
    </div>

    <!-- "Timeline" Tab Content -->
    <div id="tab-timeline" class="tab-content">
        <div class="content-grid">
            <section class="route66 animate-on-scroll grid-span-2" id="route-timeline" aria-labelledby="route-title">
                <h2 class="section-title" id="route-title">Road Trip Map</h2>
                <div class="route66__track" aria-live="polite">
                    <div class="route66__content-scroller">
                        <div class="route66__road"></div>
                        <div class="route66__progress" aria-hidden="true"></div>
                        <div class="route66__stops">
                            <button class="route66__stop" onclick="showLocationDetails('sanfran')" aria-label="San Francisco details">
                                <div class="route66__date">Sep 19–23</div><div class="route66__icon">🌉</div><div class="route66__label">San Francisco</div><div class="route66__dot"></div>
                            </button>
                            <button class="route66__stop" onclick="showLocationDetails('yosemite')" aria-label="Yosemite details">
                                <div class="route66__date">Sep 23–26</div><div class="route66__icon">🏔️</div><div class="route66__label">Yosemite</div><div class="route66__dot"></div>
                            </button>
                            <div class="route66__stop" aria-label="Death Valley (pass-through)">
                                <div class="route66__date">Sep 26</div><div class="route66__icon">🏜️</div><div class="route66__label">Death Valley</div><div class="route66__dot"></div>
                            </div>
                            <button class="route66__stop" onclick="showLocationDetails('vegas')" aria-label="Las Vegas details">
                                <div class="route66__date">Sep 26–Oct 1</div><div class="route66__icon">🎉</div><div class="route66__label">Las Vegas</div><div class="route66__dot"></div>
                            </button>
                            <button class="route66__stop" onclick="showMomentDetails('grandCanyon')" aria-label="Grand Canyon guide">
                                <div class="route66__date">Sep 30</div><div class="route66__icon">🏞️</div><div class="route66__label">Grand Canyon</div><div class="route66__dot"></div>
                            </button>
                            <button class="route66__stop" onclick="showLocationDetails('nyc')" aria-label="New York City details">
                                <div class="route66__date">Oct 1–3</div><div class="route66__icon">🗽</div><div class="route66__label">New York City</div><div class="route66__dot"></div>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="timeline-update">
                    <span id="timelineStatus">🛤️ Counting down…</span>
                    <button class="map-view-btn" onclick="toggleMapModal(true)">🗺️ View Full Map</button>
                </div>
            </section>
            <section id="dynamic-flights-section" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header">
                    <h2 class="section-title">Journey Hub</h2>
                    <p class="section-subtitle">Your live travel dashboard</p>
                </div>
                <div class="section-content">
                    <div class="flights-list" id="dynamic-flights-list"></div>
                </div>
            </section>
        </div>
    </div>

    <!-- "Places" Tab Content -->
    <div id="tab-places" class="tab-content">
        <div class="content-grid">
            <section id="destinations-hub" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header">
                    <h2 class="section-title">Destinations & Stays</h2>
                    <p class="section-subtitle">Your interactive trip itinerary</p>
                </div>
                <div class="section-content">
                    <div class="tabs" id="tabs" role="tablist"></div>
                    <div class="main-card" id="main-card" aria-live="polite">
                        <div class="hero-image" id="hero-image">
                            <h2 class="hero-image-title" id="hero-title-text"></h2>
                            <p class="hero-area" id="hero-area"></p>
                        </div>
                        <aside class="content-column" id="content-column"></aside>
                    </div>
                </div>
            </section>
            <section id="dynamic-moments-section" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header">
                    <h2 class="section-title">Epic Moments</h2>
                    <p class="section-subtitle">Unforgettable experiences planned</p>
                </div>
                <div class="section-content">
                    <div class="moments-grid" id="dynamic-moments-grid"></div>
                </div>
            </section>
        </div>
    </div>

    <!-- "Tools" Tab Content -->
    <div id="tab-tools" class="tab-content">
        <div class="content-grid">
             <div id="currency-converter-section" class="content-section currency-converter animate-on-scroll">
                <h2>💷 GBP to USD Tracker</h2>
                <div class="currency-rate" id="currency-rate">£1 = $....</div>
                <div class="currency-rate-sub" id="currency-rate-sub">Fetching latest rate...</div>
                <div class="currency-inputs">
                    <input type="number" id="currency-input" placeholder="£">
                </div>
                <div class="quick-convert-buttons">
                    <button class="quick-convert-btn" data-amount="10">£10</button>
                    <button class="quick-convert-btn" data-amount="50">£50</button>
                    <button class="quick-convert-btn" data-amount="100">£100</button>
                </div>
                <div class="conversion-result" id="conversion-result"></div>
                <div class="currency-chart">
                    <svg viewBox="0 0 300 80" preserveAspectRatio="none">
                        <path d="" class="sparkline" id="sparkline-path"></path>
                    </svg>
                </div>
                <button class="action-btn">Set Rate Alert</button>
            </div>
            <div id="trip-planner-section" class="content-section trip-planner animate-on-scroll">
                <div class="planner-header">
                    <h2>Trip Planner</h2>
                    <div class="planner-dots" id="planner-dots"></div>
                </div>
                <div class="tip-carousel" id="tip-carousel">
                    <div class="tip-track" id="tip-track">
                        <div class="tip-slide">
                            <div class="tip-icon">📦</div>
                            <div class="tip-text">
                                <h4>Smart Packing Tip</h4>
                                <p>Use packing cubes to separate clothes for different climates (e.g., SF vs. Vegas).</p>
                            </div>
                        </div>
                        <div class="tip-slide">
                            <div class="tip-icon">🔌</div>
                            <div class="tip-text">
                                <h4>Electronics Ready</h4>
                                <p>Bring a portable power bank. Long days of exploring will drain your battery fast!</p>
                            </div>
                        </div>
                        <div class="tip-slide">
                            <div class="tip-icon">💧</div>
                            <div class="tip-text">
                                <h4>Stay Hydrated</h4>
                                <p>Carry a reusable water bottle, especially in drier climates like Vegas and Yosemite.</p>
                            </div>
                        </div>
                        <div class="tip-slide">
                            <div class="tip-icon">👟</div>
                            <div class="tip-text">
                                <h4>Comfort is Key</h4>
                                <p>Pack your most comfortable walking shoes. You'll be covering a lot of ground!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- "More" Tab Content -->
    <div id="tab-more" class="tab-content">
        <div class="content-grid">
            <section id="vegas-birthday-section" class="vegas-birthday animate-on-scroll grid-span-2">
                <div class="vegas-backdrop"></div>
                <canvas id="vegasConfettiCanvas"></canvas>
                <div class="vegas-content">
                    <h2 class="neon-title">DIRTY 30</h2>
                    <p class="vegas-subtitle">The Strip • September 28th</p>
                    <button class="jackpot-btn" id="jackpotBtn" onclick="playSlots()">🎰 Hit The Jackpot 🎰</button>
                    <div class="slot-machine-container" id="slotMachineContainer">
                        <div class="slot-machine">
                            <div class="slot-reel"><div class="reel-strip" id="reel1"></div></div>
                            <div class="slot-reel"><div class="reel-strip" id="reel2"></div></div>
                            <div class="slot-reel"><div class="reel-strip" id="reel3"></div></div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="spotify-widget-section" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header">
                    <h2 class="section-title">Trip Soundtrack</h2>
                    <p class="section-subtitle">The official playlist for the road.</p>
                </div>
                <div class="section-content">
                    <iframe data-testid="embed-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/playlist/4swp2D7X1f6b2GqZiCuzPu?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                </div>
            </section>
        </div>
    </div>
</main>

<nav class="bottom-tab-nav">
    <button class="tab-btn active" data-tab="today">
        <div class="icon">☀️</div>
        <span>Today</span>
    </button>
    <button class="tab-btn" data-tab="timeline">
        <div class="icon">🗺️</div>
        <span>Timeline</span>
    </button>
    <button class="tab-btn" data-tab="places">
        <div class="icon">🌉</div>
        <span>Places</span>
    </button>
    <button class="tab-btn" data-tab="tools">
        <div class="icon">🛠️</div>
        <span>Tools</span>
    </button>
    <button class="tab-btn" data-tab="more">
        <div class="icon">🎰</div>
        <span>More</span>
    </button>
</nav>


<!-- Modals and Overlays -->
<button class="concierge-btn" onclick="toggleConcierge()"><span class="icon">✨</span></button>
<div class="modal-overlay" id="concierge-overlay" onclick="toggleConcierge()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-handle"></div>
        <div class="modal-title" id="concierge-title">Concierge</div>
        <div class="quick-actions" id="quick-actions"></div>
    </div>
</div>

<div class="map-modal-overlay" id="map-modal-overlay">
    <div class="map-modal-content">
        <button class="map-modal-close-btn" onclick="toggleMapModal(false)">✕</button>
        <div id="map-container"></div>
    </div>
</div>

<div class="wx-overlay" id="wx-overlay" onclick="toggleWx(false)">
<div class="wx-sheet" id="wx-sheet" onclick="event.stopPropagation()">
<button class="wx-close" onclick="toggleWx(false)">✕</button>
<div class="wx-top">
<div id="wx-anim-detail" class="weather-animation"></div>
<div class="wx-city" id="wx-city"></div><div class="wx-meta"><div class="wx-temp-lg" id="wx-temp-lg"></div><div class="wx-desc-lg" id="wx-desc-lg"></div></div>
<div class="wx-grid">
<div class="wx-chip"><span>Feels like</span><span id="wx-feels"></span></div><div class="wx-chip"><span>Humidity</span><span id="wx-hum"></span></div>
<div class="wx-chip"><span>Wind</span><span id="wx-wind"></span></div><div class="wx-chip"><span>Rain %</span><span id="wx-rain"></span></div>
</div>
</div>
<div class="wx-body">
<h4>Next 8 Hours</h4><div class="wx-row" id="wx-hourly-cards"></div>
<h4 style="margin-top:16px;">Next 3 Days</h4><div class="wx-days" id="wx-days-cards"></div>
</div>
</div>
</div>

<div class="modal-overlay-custom" id="modalOverlayCustom" onclick="closeCustomModal()"><div class="modal-content-custom" onclick="event.stopPropagation()"><div class="modal-header-custom"><h2 class="modal-title-custom" id="modalTitleCustom"></h2><button class="modal-close-btn" onclick="closeCustomModal()">✕</button></div><div class="modal-body-custom" id="modalBodyCustom"></div></div></div>

<!-- Boarding Pass Modal -->
<div class="boarding-pass-overlay" id="boarding-pass-overlay" onclick="closeFlightModal()">
    <div class="boarding-pass" id="boarding-pass-content" onclick="event.stopPropagation()">
      <!-- Content will be injected by JavaScript -->
    </div>
</div>

<!-- Hidden SVGs for Boarding Pass -->
<svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" display="none">
  <symbol id="airplane" viewBox="243.5 245.183 25 21.633">
    <g>
      <path fill="#336699" d="M251.966,266.816h1.242l6.11-8.784l5.711,0.2c2.995-0.102,3.472-2.027,3.472-2.308 c0-0.281-0.63-2.184-3.472-2.157l-5.711,0.2l-6.11-8.785h-1.242l1.67,8.983l-6.535,0.229l-2.281-3.28h-0.561v3.566 c-0.437,0.257-0.738,0.724-0.757,1.266c-0.02,0.583,0.288,1.101,0.757,1.376v3.563h0.561l2.281-3.279l6.535,0.229L251.966,266.816z"/>
    </g>
  </symbol>
  <symbol id="qrcode" viewBox="0 0 130 130">
   <g>
	<path fill="#334158" d="M123,3h-5h-5h-5h-5h-5h-5v5v5v5v5v5v5v5h5h5h5h5h5h5h5v-5v-5v-5v-5v-5V8V3H123z M123,13v5v5v5v5h-5h-5h-5
		h-5h-5v-5v-5v-5v-5V8h5h5h5h5h5V13z"/>
	<polygon fill="#334158" points="88,13 88,8 88,3 83,3 78,3 78,8 78,13 83,13 	"/>
	<polygon fill="#334158" points="63,13 68,13 73,13 73,8 73,3 68,3 68,8 63,8 58,8 58,13 53,13 53,8 53,3 48,3 48,8 43,8 43,13 
		48,13 48,18 43,18 43,23 48,23 53,23 53,18 58,18 58,23 63,23 63,18 	"/>
	<polygon fill="#334158" points="108,13 103,13 103,18 103,23 103,28 108,28 113,28 118,28 118,23 118,18 118,13 113,13 	"/>
	<polygon fill="#334158" points="78,18 73,18 73,23 78,23 83,23 83,18 	"/>
	<polygon fill="#334158" points="23,28 28,28 28,23 28,18 28,13 23,13 18,13 13,13 13,18 13,23 13,28 18,28 	"/>
	<polygon fill="#334158" points="53,28 53,33 53,38 58,38 58,33 58,28 58,23 53,23 	"/>
	<rect x="63" y="23" fill="#334158" width="5" height="5"/>
	<rect x="68" y="28" fill="#334158" width="5" height="5"/>
	<path fill="#334158" d="M13,38h5h5h5h5h5v-5v-5v-5v-5v-5V8V3h-5h-5h-5h-5h-5H8H3v5v5v5v5v5v5v5h5H13z M8,28v-5v-5v-5V8h5h5h5h5h5v5
		v5v5v5v5h-5h-5h-5h-5H8V28z"/>
	<polygon fill="#334158" points="48,33 48,28 43,28 43,33 43,38 48,38 	"/>
	<polygon fill="#334158" points="83,38 88,38 88,33 88,28 88,23 83,23 83,28 78,28 78,33 83,33 	"/>
	<polygon fill="#334158" points="23,43 18,43 13,43 8,43 3,43 3,48 8,48 13,48 18,48 23,48 28,48 28,43 	"/>
	<rect x="108" y="43" fill="#334158" width="5" height="5"/>
	<rect x="28" y="48" fill="#334158" width="5" height="5"/>
	<polygon fill="#334158" points="88,53 93,53 93,48 93,43 88,43 88,48 83,48 83,53 	"/>
	<polygon fill="#334158" points="123,48 123,43 118,43 118,48 118,53 118,58 123,58 123,63 118,63 113,63 113,68 118,68 118,73 
		118,78 123,78 123,83 128,83 128,78 128,73 123,73 123,68 128,68 128,63 128,58 128,53 123,53 	"/>
	<polygon fill="#334158" points="98,58 98,63 103,63 103,68 108,68 108,63 108,58 103,58 103,53 103,48 103,43 98,43 98,48 98,53 
		93,53 93,58 	"/>
	<rect x="108" y="53" fill="#334158" width="5" height="5"/>
	<rect x="78" y="63" fill="#334158" width="5" height="5"/>
	<rect x="93" y="63" fill="#334158" width="5" height="5"/>
	<rect x="53" y="68" fill="#334158" width="5" height="5"/>
	<polygon fill="#334158" points="108,73 108,78 108,83 113,83 113,78 113,73 113,68 108,68 	"/>
	<rect x="13" y="73" fill="#334158" width="5" height="5"/>
	<rect x="98" y="73" fill="#334158" width="5" height="5"/>
	<polygon fill="#334158" points="18,83 18,88 23,88 28,88 28,83 23,83 23,78 18,78 	"/>
	<polygon fill="#334158" points="8,83 8,78 8,73 8,68 13,68 13,63 13,58 13,53 8,53 3,53 3,58 3,63 3,68 3,73 3,78 3,83 3,88 8,88 	
		"/>
	<rect x="53" y="83" fill="#334158" width="5" height="5"/>
	<rect x="73" y="83" fill="#334158" width="5" height="5"/>
	<path fill="#334158" d="M108,88v-5h-5h-5h-5h-5v-5h5v-5h-5v-5h-5v5h-5h-5v-5h-5h-5v5h5v5h-5v5v5h5v-5h5v-5h5h5v5v5h-5v5h5v5h-5h-5
		v5h5v5h5v5v5h-5v5h5h5h5v5h5h5h5h5h5h5h5h5v-5v-5v-5v-5v-5v-5v-5h-5h-5v-5v-5h-5v5H108z M98,118h-5v-5h5V118z M98,103h-5h-5v-5v-5v-5
		h5h5h5v5v5v5H98z M123,118v5h-5h-5v-5h-5h-5v-5h5v-5h5v5v5h5v-5h5V118z M118,98h5v5h-5h-5v-5H118z"/>
	<path fill="#334158" d="M28,93h-5h-5h-5H8H3v5v5v5v5v5v5v5h5h5h5h5h5h5h5v-5v-5v-5v-5v-5v-5v-5h-5H28z M33,103v5v5v5v5h-5h-5h-5h-5
		H8v-5v-5v-5v-5v-5h5h5h5h5h5V103z"/>
	<rect x="93" y="93" fill="#334158" width="5" height="5"/>
	<polygon fill="#334158" points="63,98 68,98 68,93 63,93 58,93 53,93 53,88 48,88 48,83 43,83 43,78 48,78 48,73 43,73 43,68 
		48,68 53,68 53,63 58,63 58,68 63,68 63,63 63,58 68,58 73,58 73,63 78,63 78,58 83,58 83,53 78,53 78,48 83,48 83,43 83,38 78,38 
		78,33 73,33 73,38 73,43 68,43 68,38 68,33 63,33 63,38 63,43 63,48 68,48 73,48 73,53 68,53 63,53 58,53 58,58 53,58 53,53 53,48 
		58,48 58,43 53,43 48,43 43,43 38,43 33,43 33,48 38,48 38,53 33,53 33,58 38,58 43,58 43,63 38,63 33,63 33,68 38,68 38,73 33,73 
		28,73 28,68 28,63 33,63 33,58 28,58 23,58 18,58 18,63 23,63 23,68 18,68 18,73 23,73 23,78 28,78 33,78 38,78 38,83 33,83 33,88 
		38,88 43,88 43,93 43,98 48,98 48,103 53,103 53,98 58,98 58,103 58,108 63,108 63,103 	"/>
	<polygon fill="#334158" points="18,103 13,103 13,108 13,113 13,118 18,118 23,118 28,118 28,113 28,108 28,103 23,103 	"/>
	<polygon fill="#334158" points="48,108 48,103 43,103 43,108 43,113 43,118 43,123 43,128 48,128 53,128 53,123 48,123 48,118 
		48,113 53,113 58,113 58,108 53,108 	"/>
	<polygon fill="#334158" points="78,118 78,113 78,108 73,108 68,108 63,108 63,113 68,113 68,118 63,118 63,123 63,128 68,128 
		68,123 73,123 73,118 	"/>
	<rect x="73" y="123" fill="#334158" width="5" height="5"/>
</g>
  </symbol>
</svg>

<script>
/* ========== GLOBAL STATE & DATA ========== */

// --- DEBUG MODE ---
// const debugDate = new Date('2025-09-20T10:00:00-07:00');

const cities = {
sanfran:{
name:"San Francisco", timezone: "America/Los_Angeles", hero:"https://images.unsplash.com/photo-1501594907352-04cda38ebc29?q=80&w=2064&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", dates:"19–23 Sep", area:"Union Square", lat:37.7749, lon:-122.4194,
newsKeywords: "San Francisco", areaKeywords: ["Union Square", "Bay Bridge", "Golden Gate"],
stay:{ address:"The Pickwick Hotel, 85 Fifth Street, San Francisco, CA 94103", mapsLink:"https://www.google.com/maps/search/?api=1&query=The+Pickwick+Hotel+San+Francisco" },
foodRecommendations: {
    breakfast: [
        {icon:"🥞", name:"Dottie's True Blue Cafe", desc:"Classic American breakfast & brunch.", url:"https://www.google.com/maps/search/?api=1&query=Dottie's+True+Blue+Cafe+San+Francisco", veg: true},
        {icon:"🥐", name:"Tartine Bakery", desc:"World-famous pastries and coffee.", url:"https://www.google.com/maps/search/?api=1&query=Tartine+Bakery+San+Francisco", veg: true},
        {icon:"🍳", name:"Mama's on Washington", desc:"Beloved spot for brunch classics.", url:"https://www.google.com/maps/search/?api=1&query=Mama's+on+Washington+Square", veg: true}
    ],
    lunch: [
        {icon:"🍞", name:"Boudin Bakery", desc:"Sourdough bowls at the Wharf.", url:"https://www.google.com/maps/search/?api=1&query=Boudin+Bakery+Fisherman%27s+Wharf", veg: true},
        {icon:"🌯", name:"La Taqueria", desc:"Authentic Mission-style burritos.", url:"https://www.google.com/maps/search/?api=1&query=La+Taqueria+San+Francisco", veg: false},
        {icon:"🥗", name:"Souvla", desc:"Quick and delicious Greek salads.", url:"https://www.google.com/maps/search/?api=1&query=Souvla+San+Francisco", veg:true}
    ],
    dinner: [
        {icon:"🌱", name:"Greens Restaurant", desc:"Iconic vegetarian dining with views.", url:"https://www.google.com/maps/search/?api=1&query=Greens+Restaurant+Fort+Mason", veg:true},
        {icon:"🥩", name:"House of Prime Rib", desc:"An old-school SF institution.", url:"https://www.google.com/maps/search/?api=1&query=House+of+Prime+Rib+San+Francisco", veg: false},
        {icon:"🐦", name:"State Bird Provisions", desc:"Adventurous, modern American food.", url:"https://www.google.com/maps/search/?api=1&query=State+Bird+Provisions", veg: true}
    ],
    anytime: [
        {icon:"🍔", name:"In-N-Out Burger", desc:"California's iconic fast-food burger.", url:"https://www.google.com/maps/search/?api=1&query=In-N-Out+Burger+San+Francisco", veg: true}
    ]
},
flights:[ { id: "flight01", route:"LHR → SFO", airline: "Virgin Atlantic", number:"VS19", status:"Booked", departureTime: "2025-09-19T11:15:00+01:00", arrivalTime: "2025-09-19T14:20:00-07:00", duration: "11h 5m", checkinURL: "https://www.virginatlantic.com/gb/en/travel-information/check-in.html" } ],
concierge:[ {icon:"🗺️", label:"Maps", url:"https://www.google.com/maps/search/?api=1&query=Union+Square+San+Francisco"}, {icon:"☕", label:"Coffee", url:"https://www.google.com/maps/search/?api=1&query=coffee+near+Union+Square+SF"}, {icon:"💊", label:"Pharmacy", url:"https://www.google.com/maps/search/?api=1&query=pharmacy+near+Union+Square+SF"}, {icon:"🌱", label:"Vegetarian", url:"https://www.google.com/maps/search/?api=1&query=vegetarian+food+near+Union+Square+SF"}, {icon:"🛍️", label:"Shopping", url:"https://www.google.com/maps/search/?api=1&query=shopping+near+Union+Square+SF"}, {icon:"🚕", label:"Uber", url:"https://m.uber.com/ul/"} ]
},
yosemite:{
name:"Yosemite", timezone: "America/Los_Angeles", hero:"https://images.unsplash.com/photo-1516687401797-25297ff1462c?q=80&w=1740&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", dates:"23–26 Sep", area:"Oakhurst", lat:37.3294, lon:-119.6527,
newsKeywords: "Yosemite", areaKeywords: ["Yosemite Valley", "Tioga Pass", "Glacier Point"],
stay:{ address: "Airbnb: Oakhurst, 43041 Country Club Drive West", mapsLink: "https://www.google.com/maps/search/?api=1&query=43041+Country+Club+Drive+West+Oakhurst+CA" },
driveInfo: { id: "drive01", from: "San Francisco", to: "Yosemite", date: "2025-09-23", duration: "Approx. 6 hours", fact: "The drive takes you through California's Central Valley, one of the world's most productive agricultural regions.", mapsLink: "https://www.google.com/maps/dir/San+Francisco,+CA/Oakhurst,+CA" },
foodRecommendations:{
    breakfast: [
        {icon:"☕", name:"Degnan's Kitchen", desc:"Grab-and-go breakfast and coffee.", url:"https://www.google.com/maps/search/?api=1&query=Degnan's+Kitchen+Yosemite", veg: true},
        {icon:"食堂", name:"Base Camp Eatery", desc:"Cafeteria-style with good options.", url:"https://www.google.com/maps/search/?api=1&query=Base+Camp+Eatery+Yosemite", veg: true}
    ],
    lunch: [
        {icon:"🍔", name:"Village Grill Deck", desc:"Classic grill fare with great views.", url:"https://www.google.com/maps/search/?api=1&query=Village+Grill+Yosemite", veg:true},
        {icon:"🍕", name:"Curry Village Pizza", desc:"Casual outdoor patio pies.", url:"https://www.google.com/maps/search/?api=1&query=Curry+Village+Pizza+Deck", veg: true}
    ],
    dinner: [
        {icon:"🏨", name:"The Ahwahnee Dining", desc:"Historic fine dining experience.", url:"https://www.google.com/maps/search/?api=1&query=The+Ahwahnee+Dining+Room", veg: true},
        {icon:"🥩", name:"Mountain Room", desc:"Upscale lodge dining with views.", url:"https://www.google.com/maps/search/?api=1&query=Mountain+Room+Restaurant+Yosemite", veg: false}
    ]
},
concierge:[ {icon:"🏔️", label:"Visitor Center", url:"https://www.google.com/maps/search/?api=1&query=Yosemite+Valley+Visitor+Center"}, {icon:"🥾", label:"Trail Maps", url:"https://www.nps.gov/yose/planyourvisit/maps.htm"}, {icon:"🚌", label:"Shuttle", url:"https://www.nps.gov/yose/planyourvisit/publictransportation.htm"}, {icon:"⛽", label:"Gas", url:"https://www.nps.gov/yose/planyourvisit/gas.htm"}, {icon:"🚗", label:"Roads", url:"https://www.nps.gov/yose/planyourvisit/conditions.htm"}, {icon:"📸", label:"Webcams", url:"https://www.nps.gov/yose/learn/photosmultimedia/webcams.htm"} ]
},
vegas:{
name:"Las Vegas", timezone: "America/Los_Angeles", hero:"https://images.unsplash.com/photo-1583207884889-d79abf0d0aa3?q=80&w=1768&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", dates:"26 Sep–1 Oct", area:"The Strip", lat:36.1699, lon:-115.1398,
newsKeywords: "Las Vegas", areaKeywords: ["The Strip", "I-15", "Bellagio"],
stay:{ address: "The Boulevard, a Hilton Grand Vacations Club, 2650 Las Vegas Blvd. South Las Vegas, NV 89109", mapsLink: "https://www.google.com/maps/search/?api=1&query=The+Boulevard,+a+Hilton+Grand+Vacations+Club" },
driveInfo: { id: "drive02", from: "Yosemite", to: "Las Vegas", date: "2025-09-26", duration: "Approx. 9-10 hours", fact: "This epic drive takes you through the dramatic landscapes of Death Valley National Park.", mapsLink: "https://www.google.com/maps/dir/Oakhurst,+CA/Furnace+Creek,+CA/Las+Vegas,+NV" },
foodRecommendations:{
    breakfast: [
        {icon:"🍳", name:"Eggslut", desc:"Gourmet breakfast sandwiches.", url:"https://www.google.com/maps/search/?api=1&query=Eggslut+Las+Vegas", veg: true},
        {icon:"🌿", name:"Tableau", desc:"Upscale brunch with great veg options.", url:"https://www.google.com/maps/search/?api=1&query=Tableau+Las+Vegas", veg: true},
        {icon:"🐔", name:"Hash House A Go Go", desc:"Famously huge portions.", url:"https://www.google.com/maps/search/?api=1&query=Hash+House+A+Go+Go+Las+Vegas", veg: true}
    ],
    lunch: [
        {icon:"🌮", name:"Tacos El Gordo", desc:"Famous Tijuana-style tacos.", url:"https://www.google.com/maps/search/?api=1&query=Tacos+El+Gordo+Las+Vegas", veg: true},
        {icon:"🍽️", name:"Bacchanal Buffet", desc:"Legendary buffet with endless options.", url:"https://www.google.com/maps/search/?api=1&query=Bacchanal+Buffet", veg: true},
        {icon:"🍕", name:"Secret Pizza", desc:"Hidden spot for a great slice.", url:"https://www.google.com/maps/search/?api=1&query=Secret+Pizza+Las+Vegas", veg: true}
    ],
    dinner: [
        {icon:"🌱", name:"Crossroads Kitchen", desc:"Upscale, popular plant-based dining.", url:"https://www.google.com/maps/search/?api=1&query=Crossroads+Kitchen+Las+Vegas", veg:true},
        {icon:"🇹🇭", name:"Lotus of Siam", desc:"Often called the best Thai food in the US.", url:"https://www.google.com/maps/search/?api=1&query=Lotus+of+Siam+Las+Vegas", veg: true},
        {icon:"🥩", name:"Gordon Ramsay Steak", desc:"High-end steakhouse experience.", url:"https://www.google.com/maps/search/?api=1&query=Gordon+Ramsay+Steak+Las+Vegas", veg: false}
    ],
    anytime: [
        {icon:"🍔", name:"In-N-Out Burger", desc:"The best fast-food burger, period.", url:"https://www.google.com/maps/search/?api=1&query=In-N-Out+Burger+Las+Vegas", veg: true},
        {icon:"🌮", name:"Taco Bell Cantina", desc:"Boozy slushies and tacos on the Strip.", url:"https://www.google.com/maps/search/?api=1&query=Taco+Bell+Cantina+Las+Vegas+Strip", veg: true},
        {icon:"🍽️", name:"The Henry", desc:"24/7 classy diner inside The Cosmo.", url:"https://www.google.com/maps/search/?api=1&query=The+Henry+at+The+Cosmopolitan+of+Las+Vegas", veg: true}
    ]
},
flights:[ { id: "flight02", route:"LAS → JFK", airline: "JetBlue", number:"B6348", status:"Booked", departureTime: "2025-10-01T13:35:00-07:00", arrivalTime: "2025-10-01T21:49:00-04:00", duration: "5h 14m", checkinURL: "https://www.jetblue.com/checkin" } ],
concierge:[ {icon:"🎰", label:"Casinos", url:"https://www.google.com/maps/search/?api=1&query=casinos+Las+Vegas+Strip"}, {icon:"🍸", label:"Best Bars", url:"https://www.google.com/search?q=best+cocktail+bars+las+vegas"}, {icon:"🎭", label:"Shows", url:"https://www.google.com/search?q=las+vegas+shows+tickets"}, {icon:"🍽️",label:"Buffets", url:"https://www.google.com/search?q=best+buffets+las+vegas"}, {icon:"☀️", label:"Pool Parties", url:"https://www.google.com/search?q=las+vegas+day+clubs+pool+parties"}, {icon:"🚕", label:"Uber", url:"https://m.uber.com/ul/"} ]
},
nyc:{
name:"New York City", timezone: "America/New_York", hero:"https://images.unsplash.com/photo-1570304816841-906a17d7b067?q=80&w=2064&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D", dates:"1–3 Oct", area:"Midtown", lat:40.7128, lon:-74.0060,
newsKeywords: "New York", areaKeywords: ["Midtown", "Times Square", "FDR Drive"],
stay:{ address: "Tuscany Hotel by LuxUrban, 120 E 39th St, New York, NY 10016", mapsLink: "https://www.google.com/maps/search/?api=1&query=Tuscany+Hotel+by+LuxUrban+New+York" },
foodRecommendations: {
    breakfast: [
        {icon:"🥯", name:"Ess-a-Bagel", desc:"A true classic New York bagel.", url:"https://www.google.com/maps/search/?api=1&query=Ess-a-Bagel", veg: true},
        {icon:"🥞", name:"Clinton St. Baking Co.", desc:"Famous for incredible pancakes.", url:"https://www.google.com/maps/search/?api=1&query=Clinton+St.+Baking+Company+%26+Restaurant", veg: true},
        {icon:"🥟", name:"Nom Wah Tea Parlor", desc:"Historic dim sum in Chinatown.", url:"https://www.google.com/maps/search/?api=1&query=Nom+Wah+Tea+Parlor", veg: true}
    ],
    lunch: [
        {icon:"🍕", name:"Joe’s Pizza", desc:"The quintessential NY slice.", url:"https://www.google.com/maps/search/?api=1&query=Joe%27s+Pizza+NYC", veg: true},
        {icon:"🥙", name:"Mamoun's Falafel", desc:"Legendary, cheap, and delicious falafel.", url:"https://www.google.com/maps/search/?api=1&query=Mamoun's+Falafel+NYC", veg: true},
        {icon:"🥪", name:"Katz's Delicatessen", desc:"Legendary pastrami sandwiches.", url:"https://www.google.com/maps/search/?api=1&query=Katz's+Delicatessen", veg: false}
    ],
    dinner: [
        {icon:"🍜", name:"Ippudo", desc:"World-class ramen bowls.", url:"https://www.google.com/maps/search/?api=1&query=Ippudo+NYC", veg: true},
        {icon:"🌱", name:"Hangawi", desc:"Upscale, traditional Korean vegetarian.", url:"https://www.google.com/maps/search/?api=1&query=Hangawi+NYC", veg: true},
        {icon:"🥩", name:"Peter Luger Steak House", desc:"An iconic Brooklyn steakhouse.", url:"https://www.google.com/maps/search/?api=1&query=Peter+Luger+Steak+House", veg: false}
    ],
    anytime: [
        {icon:"🍔", name:"McDonald's", desc:"Open late, you know what it is.", url:"https://www.google.com/maps/search/?api=1&query=McDonalds+near+Midtown+New+York", veg: true},
        {icon:"🍗", name:"Popeyes", desc:"Louisiana-style fried chicken.", url:"https://www.google.com/maps/search/?api=1&query=Popeyes+near+Midtown+New+York", veg: false},
        {icon:"🇨🇺", name:"Coppelia", desc:"24/7 Cuban-American diner.", url:"https://www.google.com/maps/search/?api=1&query=Coppelia+NYC", veg: true}
    ]
},
flights:[ { id: "flight03", route:"JFK → LHR", airline: "Virgin Atlantic", number:"VS138", status:"Booked", departureTime: "2025-10-03T23:00:00-04:00", arrivalTime: "2025-10-04T11:10:00+01:00", duration: "7h 10m", checkinURL: "https://www.virginatlantic.com/gb/en/travel-information/check-in.html" } ],
concierge:[ {icon:"🚇", label:"Subway Map", url:"https://new.mta.info/map/5256"}, {icon:"🍕", label:"Best Pizza", url:"https://www.google.com/search?q=best+pizza+slice+nyc"}, {icon:"🎭", label:"Broadway", url:"https://www.broadway.com/"}, {icon:"🏛️", label:"Museums", url:"https://www.google.com/search?q=best+museums+in+nyc"}, {icon:"🍸", label:"Rooftops", url:"https://www.google.com/search?q=best+rooftop+bars+nyc"}, {icon:"🚕", label:"Uber", url:"https://m.uber.com/ul/"} ]
}
};

const stops = [
  { id:'sanfran', start:'2025-09-19', end:'2025-09-23' },
  { id:'yosemite', start:'2025-09-23', end:'2025-09-26' },
  { id:'vegas', start:'2025-09-26', end:'2025-10-01' },
  { id:'nyc', start:'2025-10-01', end:'2025-10-03' },
];

const travelDayItineraries = {
    drive02: [ // Drive from Yosemite to Vegas
        { time: 'Morning', icon: '🌅', title: 'Depart Yosemite', description: 'Enjoy a final breakfast in the valley, check out, and hit the road.' },
        {
            time: 'Mid-day',
            icon: '🏜️',
            title: 'Stop: Death Valley',
            description: 'Experience one of the hottest places on Earth. A landscape of extremes.',
            poi: 'Zabriskie Point offers an iconic, otherworldly vista. Keep your visit brief and stay hydrated!'
        },
        { time: 'Evening', icon: '🌆', title: 'Arrive in Las Vegas', description: 'Welcome to the oasis of lights! Check into your hotel and prepare for the contrast.' }
    ]
};

// --- NEW: Daily Itinerary ---
const dailyItinerary = {
    '2025-09-20': ['alcatraz', 'cableCar'],
    '2025-09-21': ['ggSunrise', 'muirWoods'],
    '2025-09-24': ['mistTrail', 'tunnelViewSunset'],
    '2025-09-25': ['sequoias', 'stargazing'],
    '2025-09-27': ['sphere'],
    '2025-09-28': ['vegasNight'],
    '2025-09-30': ['hooverDam', 'grandCanyon'],
    '2025-10-02': ['topOfRock', 'broadway', 'brooklynBridge']
};


const momentData = {
ggSunrise:{ cityId: 'sanfran', icon:"🌉", title:'Golden Gate Sunrise', timeOfDay: 'Morning', description:'Catching the first light over the iconic bridge from the Marin Headlands. Remember to bring a wind-proof layer!', locations:[{name:'Battery Spencer', why:'The classic postcard view'}, {name:'Hawk Hill', why:'A higher, wider perspective'}],
tips: [
{ text: "The 'marine layer' (fog) is common. Check a live webcam before you go for the best chance of a clear view." },
{ text: "It's a clear morning! This is rare and perfect for photography.", condition: { code: [0, 1, 2] } },
{ text: "With dense fog, you might not see the bridge, but the moody atmosphere can still be very beautiful.", condition: { code: [45, 48] } }
]},
alcatraz:{ cityId: 'sanfran', icon:"⛓️", title:'Alcatraz Island Tour', timeOfDay: 'Afternoon', description:'Explore the historic and infamous island prison in the San Francisco Bay. Book tickets well in advance!', locations:[{name:'Alcatraz Island', why:'Main prison tour'}, {name:'Pier 33 Alcatraz Landing', why:'Ferry departure point'}],
tips: [
{ text: "The audio tour is excellent and highly recommended to get the full story." },
{ text: "It's often much colder and windier on the island than in the city. Bring extra layers!" }
]},
cableCar:{ cityId: 'sanfran', icon:"🚃", title:'Ride a Cable Car', timeOfDay: 'Evening', description:"Experience San Francisco's iconic moving landmark and see the city from a unique angle.", locations:[{name:'Powell-Hyde Cable Car Line', why:'Most scenic route'}, {name:'Cable Car Museum', why:'See the giant winding wheels'}],
tips: [
{ text: "Hold on tight! Standing on the running boards offers the most thrilling experience." }
]},
muirWoods:{ cityId: 'sanfran', icon:"🌲", title:'Walk with Giants', timeOfDay: 'Afternoon', description:'A serene trip to Muir Woods National Monument to stand in awe of the coastal redwoods.', locations:[{name:'Muir Woods National Monument', why:'Main visitor trails'}, {name:'Muir Beach Overlook', why:'Stunning coastal views nearby'}]},
stargazing:{ cityId: 'yosemite', icon:"🌌", title:'Yosemite Stargazing', timeOfDay: 'Night', description:'Witness the Milky Way in a certified dark sky park, far from city lights.', locations:[{name:'Glacier Point', why:'Panoramic sky with Half Dome'}, {name:'Tunnel View', why:'Iconic valley view, also great for stars'}]},
mistTrail:{ cityId: 'yosemite', icon:"💦", title:'Hike the Mist Trail', timeOfDay: 'Morning', description:'A signature Yosemite hike to the base of the powerful Vernal Fall. Bring a poncho!', locations:[{name:'Vernal Fall Footbridge', why:'First great viewpoint'}, {name:'Top of Vernal Fall', why:'Feel the power (and spray)'}],
tips: [
{ text: "You WILL get wet from the waterfall's spray, even on a sunny day. Protect your electronics." },
{ text: "With recent rain, the stone steps can be very slippery. Take your time and use the handrails.", condition: { code: [61, 63, 65, 80] } }
]},
sequoias:{ cityId: 'yosemite', icon:"🌲", title:'Mariposa Grove', timeOfDay: 'Morning', description:'Walk among a forest of giant sequoia trees, some of the largest living things on Earth.', locations:[{name:'Grizzly Giant', why:'One of the largest trees'}, {name:'California Tunnel Tree', why:'The famous walk-through tree'}]},
tunnelViewSunset: { cityId: 'yosemite', icon:"🌅", title:'Tunnel View Sunset', timeOfDay: 'Evening', description:"Watch the last light of day paint El Capitan and Half Dome in incredible colors from this classic viewpoint.", locations:[{name:'Tunnel View, Yosemite', why:'The most famous viewpoint in the park'}]},
vegasNight:{ cityId: 'vegas', icon:"🎰", title:'Vegas Boys Night', timeOfDay: 'Evening', description:"A celebratory night out exploring iconic bars and neon-lit streets.", locations:[{name:'The Chandelier Bar', why:'Cocktails inside a crystal masterpiece'},{name:'Fountains of Bellagio', why:'Classic Vegas spectacle'}, {name:'Fremont Street Experience', why:'Classic neon & live music'}]},
sphere:{ cityId: 'vegas', icon:"🌐", title:'MSG Sphere Experience', timeOfDay: 'Evening', description:"An absolute must-see. The future of immersive entertainment. Arrive early for the full experience and aim for central seats.", locations:[{name:'MSG Sphere Las Vegas', why:'The main attraction'}]},
grandCanyon:{ cityId: 'vegas', icon:"🏞️", title:'Grand Canyon Day Trip', timeOfDay: 'Afternoon', description:'Take a helicopter from Las Vegas for a breathtaking flight over and into the West Rim, or take a scenic drive to the iconic South Rim for classic views.', locations:[{name:"Maverick Helicopters LV", why:"Departure for West Rim tours"}, {name:"Grand Canyon South Rim", why:"Drive for Mather Point vistas"}],
tips: [
{ text: "Book the first flight of the morning for the smoothest air and best light." },
{ text: "It's a brilliantly clear day. You'll have incredible visibility for miles!", condition: { code: [0, 1, 2] } },
{ text: "It's very hot today. Stay hydrated! Drink water even if you don't feel thirsty.", condition: { temp_gt: 30 } }
]},
hooverDam:{ cityId: 'vegas', icon:"🌊", title:'Hoover Dam Tour', timeOfDay: 'Morning', description:"A morning tour to marvel at this incredible feat of modern engineering.", locations:[{name:'Hoover Dam', why:'Take the Power Plant or Full Dam Tour'}, {name:"Boulder City", why:"Historic town for a coffee stop"}]},
broadway:{ cityId: 'nyc', icon:"🎭", title:'Broadway Show', timeOfDay: 'Evening', description:'A night of world-class theatre in the heart of Manhattan.', locations:[{name:'TKTS Ticket Booth Times Square', why:'Discounted same-day tickets'}, {name:'Broadway Theatre District', why:'The heart of it all'}]},
topOfRock:{ cityId: 'nyc', icon:"🏙️", title:'Top of the Rock', timeOfDay: 'Afternoon', description:'Get the best, unobstructed 360° views of the NYC skyline.', locations:[{name:'Top of the Rock Observation Deck', why:'The main viewpoint'}]},
brooklynBridge:{ cityId: 'nyc', icon:"🌉", title:'Brooklyn Bridge Walk', timeOfDay: 'All Day', description:'The classic walk from Brooklyn to Manhattan offers unforgettable views of the city skyline. Go early to avoid crowds.', locations:[{name:"DUMBO - Washington Street", why:"Starting point for the classic photo"}, {name:"Brooklyn Bridge Pedestrian Walkway", why:'The walk itself'}],
tips: [
{ text: "Walk from the Brooklyn side towards Manhattan for the best skyline views." },
{ text: "It's raining, so the walkway might be less crowded, but watch your step on the wooden planks.", condition: { code: [61, 63, 65, 80] } }
]}
};

const airlineColors = {
    'Virgin Atlantic': { primary: '#E11937', secondary: '#A01D32', text: '#FFFFFF' },
    'JetBlue': { primary: '#003876', secondary: '#005E9B', text: '#FFFFFF' },
    'default': { primary: '#36475f', secondary: '#2c394f', text: '#FFFFFF' }
};

// --- SINGLE SOURCE OF TRUTH for trip start time ---
const TRIP_START_DATE = new Date(cities.sanfran.flights[0].departureTime);
const TRIP_END_DATE = new Date(cities.nyc.flights[0].arrivalTime);


let currentCityId = 'sanfran';
let masterInterval;
let weatherCache = new Map();
let intelligenceCache = new Map();
let currentUSDRate = null;
let map;
let mapInitialized = false;
let isInitialLoad = true;

/* ========== LIVE TRAVEL INTELLIGENCE ENGINE (RE-ENGINEERED) ========== */

async function fetchRSS(feedUrl, keywords = []) {
    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(feedUrl)}`;
    try {
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const str = await response.text();
        const doc = new window.DOMParser().parseFromString(str, "text/xml");
        const items = [];
        
        doc.querySelectorAll("item").forEach(item => {
            const title = item.querySelector("title")?.textContent || "";
            const descriptionNode = item.querySelector("description") || item.querySelector("encoded");
            const description = descriptionNode?.textContent.replace(/<[^>]+>/g, '').substring(0, 120) + '...' || "";
            const link = item.querySelector("link")?.textContent || "#";

            const hasKeyword = keywords.length === 0 || keywords.some(k =>
                title.toLowerCase().includes(k.toLowerCase()) ||
                description.toLowerCase().includes(k.toLowerCase())
            );

            if (hasKeyword) {
                items.push({ title, desc: description, link, source: new URL(feedUrl).hostname.replace('www.','') });
            }
        });
        return items;
    } catch (error) {
        console.error(`Error fetching RSS feed ${feedUrl}:`, error);
        return [];
    }
}

async function getWeatherAlerts(city) {
    const weather = await fetchWeather(city);
    if (!weather) return null;
    
    const alertMapping = {
        65: { type: 'critical', icon: '🌧️', title: 'Heavy Rain Warning', desc: `Heavy rain is currently occurring, which may lead to localized flooding.` },
        95: { type: 'critical', icon: '⛈️', title: 'Thunderstorm Warning', desc: `A thunderstorm is in the area. Seek shelter and avoid open spaces.` },
        45: { type: 'alert', icon: '🌫️', title: 'Fog Advisory', desc: `Visibility may be reduced due to fog. Use caution when driving or walking.` }
    };

    const alert = alertMapping[weather.current.weather_code];
    if (alert) {
        return { ...alert, source: 'Live Weather Service' };
    }
    return null;
}

async function getProactiveBriefing(city) {
    const weather = await fetchWeather(city);
    if (!weather) return null;

    const cityTime = new Date(getCurrentTime().toLocaleString('en-US', { timeZone: city.timezone }));
    const currentHour = cityTime.getHours();

    const todaysMomentIds = dailyItinerary[getCurrentTime().toISOString().split('T')[0]] || [];
    const hasSunsetMomentToday = todaysMomentIds.some(id => momentData[id]?.bestTime === 'sunset');

    if (hasSunsetMomentToday && currentHour >= 16 && currentHour <= 19 && [0, 1, 2, 3].includes(weather.current.weather_code)) {
        return {
            type: 'briefing',
            icon: '💡',
            title: "Today's Briefing",
            desc: `<strong>Golden hour is approaching!</strong> Conditions are looking great for your planned sunset photo op.`,
            source: 'AI Assistant'
        };
    }
    if ([0, 1, 2].includes(weather.current.weather_code) && currentHour >= 9 && currentHour <= 15) {
         return {
            type: 'briefing',
            icon: '☀️',
            title: "Today's Briefing",
            desc: `It's a beautiful day in ${city.name}! Perfect weather for exploring or any outdoor activities you have planned.`,
            source: 'Live Weather'
        };
    }
    return null;
}

async function getSportsNews() {
    let sportsNews = [];
    const golfNews = await fetchRSS('https://www.espn.com/espn/rss/golf/news', ['Ryder Cup']);
    if (golfNews.length > 0) {
        sportsNews.push({ ...golfNews[0], icon: '⛳', type: 'briefing', source: 'ESPN Golf' });
    }
    const footballNews = await fetchRSS('https://feeds.skysports.com/api/v2/feeds/rss/football');
     if (footballNews.length > 0) {
        const premierLeagueStory = footballNews.find(item => item.title.toLowerCase().includes('premier league')) || footballNews[0];
        sportsNews.push({ ...premierLeagueStory, icon: '⚽', type: 'briefing', source: 'Sky Sports' });
    }
    return sportsNews;
}


async function generateIntelligenceCards(cityId) {
    const city = cities[cityId];
    let cards = [];

    // City-specific providers
    const providers = [
        () => getWeatherAlerts(city),
        () => getProactiveBriefing(city),
    ];

    for (const provider of providers) {
        if (cards.length >= 2) break;
        try {
            const result = await provider();
            if (result) {
                 const newCards = Array.isArray(result) ? result : [result];
                 for (const card of newCards) {
                    if (card && !cards.some(c => c.title === card.title)) {
                        cards.push(card);
                    }
                 }
            }
        } catch (error) {
            console.error("Intelligence provider failed:", error);
        }
    }
    
    // Fallback if no city-specific cards were found
    if (cards.length === 0) {
        cards.push({
            icon: '✨',
            title: `Explore ${city.name}`,
            desc: `The city is yours to discover! Check out the "Epic Moments" section for some great ideas for your trip.`,
            source: 'Your Itinerary',
            type: 'briefing'
        });
    }

    return cards;
}


/* ========== INITIALIZATION ========== */
document.addEventListener('DOMContentLoaded', () => {
    setupTabNavigation();
    
    // Initial page load
    updateTodayTab(true); // `true` indicates it's the first structural render
    
    // Initialize other tabs' static content
    updateTimelineStatus();
    buildTabsForPlaces();
    switchCity(currentCityId, true);
    setupTripPlanner();
    fetchCurrencyRate();
    observeScrollAnimations();
    
    // Set up the interval for live data updates (no page reloads)
    if(masterInterval) clearInterval(masterInterval);
    masterInterval = setInterval(updateLiveWidgets, 60 * 1000); // Update every 60 seconds
});

/* ========== NEW: APP CORE LOGIC ========== */

function setupTabNavigation() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const headerTitle = document.getElementById('app-header-title');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.dataset.tab;

            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });
            
            headerTitle.textContent = button.querySelector('span').textContent;
            window.scrollTo({ top: 0, behavior: 'smooth' });

             if (tabName === 'today') {
                updateTodayTab(true); // Full render on tab switch
             } else {
                updateLiveWidgets(); // Just update live data on other tabs
             }
        });
    });
}

function getTripPhase() {
    const now = getCurrentTime();
    if (now < TRIP_START_DATE) return 'pre-trip';
    if (now > TRIP_END_DATE) return 'post-trip';
    return 'in-trip';
}

// **MODIFIED:** `isStructuralRender` flag prevents re-rendering the whole page on interval updates
async function updateTodayTab(isStructuralRender = false) {
    const phase = getTripPhase();
    const container = document.getElementById('today-view-content');

    if (isStructuralRender) {
         switch (phase) {
            case 'pre-trip':
                container.innerHTML = renderPreTripView();
                setupCountdown();
                cloneAndSetupPlanner();
                renderPreTripIntelligence(); // Fetch pre-trip data
                break;
            case 'in-trip':
                const todayTravel = getTodaysTravel();
                const currentCityInfo = getCurrentCityOnTrip();
                if (todayTravel) {
                    container.innerHTML = renderTravelDayView(todayTravel);
                } else if (currentCityInfo) {
                    container.innerHTML = renderStayDayView(currentCityInfo);
                } else {
                    container.innerHTML = `<div class="hero-card"><h2 class="hero-title">In Transit</h2><p class="hero-subtitle">You're between destinations. Check the Timeline for details.</p></div>`;
                }
                break;
            case 'post-trip':
                container.innerHTML = renderPostTripView();
                break;
        }
        observeScrollAnimations();
    }
   
    // Live data updates happen regardless of structural render
    updateLiveWidgets();
}

// **NEW:** This function updates only live data without reloading the page structure
async function updateLiveWidgets() {
    updateJourneyHub();
    updateRealProgress();

    const currentCityInfo = getCurrentCityOnTrip();
    if(currentCityInfo) {
        const activeTabId = document.querySelector('.tab-content.active').id;
        if(activeTabId === 'tab-today') {
            await renderWeather(currentCityInfo.id, 'weather-widget-today');
            updateFoodConcierge(currentCityInfo.id);
            await renderLiveIntelligence(currentCityInfo.id);
        }
    }
}


function renderPreTripView() {
    const diff = TRIP_START_DATE.getTime() - getCurrentTime().getTime();
    
    let quickActionsHTML = `
        <a href="#" onclick="switchTabs('tools'); return false;" class="quick-action-card">
            <div class="icon">📦</div>
            <div class="label">Packing Tips</div>
        </a>
        <a href="#" onclick="switchTabs('places'); return false;" class="quick-action-card">
            <div class="icon">🗺️</div>
            <div class="label">Explore Places</div>
        </a>
    `;

    const hoursUntilDeparture = diff / 3600000;
    if (hoursUntilDeparture <= 24) {
        const flight = cities.sanfran.flights[0];
        quickActionsHTML = `
            <a href="${flight.checkinURL}" target="_blank" class="quick-action-card primary">
                <div class="icon">✈️</div>
                <div class="label">Check-In Now</div>
            </a>` + quickActionsHTML;
    }
    
    return `
        <div class="hero-card">
            <h2 class="hero-title">Your American Adventure</h2>
            <p class="hero-subtitle">The countdown is on!</p>
            <div class="countdown-container">
                <div class="countdown-card"><span class="countdown-value" id="days">--</span><div class="countdown-label">Days</div></div>
                <div class="countdown-card"><span class="countdown-value" id="hours">--</span><div class="countdown-label">Hours</div></div>
                <div class="countdown-card"><span class="countdown-value" id="minutes">--</span><div class="countdown-label">Minutes</div></div>
                <div class="countdown-card"><span class="countdown-value" id="seconds">--</span><div class="countdown-label">Seconds</div></div>
            </div>
        </div>
        <div class="quick-actions-grid" style="padding: 0 16px;">
            ${quickActionsHTML}
        </div>
        <div class="content-grid">
             <div id="trip-planner-section-today" class="content-section trip-planner animate-on-scroll grid-span-2">
                <div class="planner-header">
                    <h2>Preparation Checklist</h2>
                    <div class="planner-dots" id="planner-dots-today"></div>
                </div>
                <div class="tip-carousel" id="tip-carousel-today">
                    <div class="tip-track" id="tip-track-today">
                        <!-- Cloned content will go here -->
                    </div>
                </div>
            </div>
            <section id="live-intelligence-section" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header">
                    <h2 class="section-title">Pre-Trip Intelligence</h2>
                    <p class="section-subtitle">Your briefing before you fly</p>
                </div>
                <div class="section-content">
                    <div class="intelligence-list" id="intelligence-list"></div>
                </div>
            </section>
        </div>
    `;
}

function renderTravelDayView(travelInfo) {
    let heroHTML = '';
    let itineraryHTML = '';

    if (travelInfo.type === 'flight') {
        const flight = travelInfo.data;
        heroHTML = `<div class="hero-card"><h2 class="hero-title">✈️ Flight Day</h2><p class="hero-subtitle">${flight.route}</p></div>`;
        itineraryHTML = `<div class="content-grid"><div class="content-section grid-span-2"><div class="flight-container" id="${flight.id}" style="padding: 20px;"></div></div></div>`;
    } else if (travelInfo.type === 'drive') {
        const drive = travelInfo.data;
        const itinerary = travelDayItineraries[drive.id] || [];
        const destinationCity = Object.values(cities).find(c => c.name === drive.to);
        heroHTML = `<div class="hero-card"><h2 class="hero-title">🚗 Road Trip Day</h2><p class="hero-subtitle">${drive.from} to ${drive.to}</p></div>`;
        itineraryHTML = `
            <div class="content-grid">
                <section class="content-section grid-span-2">
                    <div class="section-header"><h2 class="section-title">Today's Journey</h2></div>
                    <div class="section-content">
                        <div class="widget-list" style="display: flex; flex-direction: column; gap: 0;">
                           ${itinerary.map(step => `
                           <div class="widget-item" style="border-radius:0; border-right:0; border-left:0; border-top:0; padding-left:0; padding-right:0;">
                               <div class="widget-icon">${step.icon}</div>
                               <div class="widget-text">
                                  <h4>${step.time}: ${step.title}</h4>
                                  <p>${step.description}${step.poi ? `<br><strong>Point of Interest:</strong> ${step.poi}` : ''}</p>
                               </div>
                           </div>
                           `).join('')}
                           <a class="widget-item a" href="${destinationCity.stay.mapsLink}" target="_blank" rel="noopener" style="border-radius:0; border:0; padding-left:0; padding-right:0; background: var(--success); color: white; margin-top: 12px; border-radius: var(--radius-lg);">
                                <div class="widget-icon" style="color: white;">🏨</div>
                                <div class="widget-text"><h4>Navigate to Your Stay</h4><p style="color: rgba(255,255,255,0.8);">${destinationCity.stay.address}</p></div>
                           </a>
                        </div>
                    </div>
                </section>
            </div>`;
    }
    return heroHTML + itineraryHTML;
}

function renderStayDayView(cityInfo) {
    const city = cityInfo.data;
    const now = getCurrentTime();
    const todayKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    const todaysMomentIds = dailyItinerary[todayKey] || [];

    let todaysPlanHtml = '';
    if (todaysMomentIds.length > 0) {
        todaysPlanHtml = `
            <section id="todays-plan-section" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header"><h2 class="section-title">Today's Plan</h2></div>
                <div class="section-content">
                    <div class="widget" style="padding:0; border:none; box-shadow:none;">
                        <div class="widget-list" style="display: flex; flex-direction: column;">
                           ${todaysMomentIds.map(momentId => {
                               const momentDetails = momentData[momentId];
                               if (!momentDetails) return '';
                               return `<a class="widget-item a" href="#" onclick="openCustomModal('${momentId}'); return false;">
                                   <div class="widget-icon">${momentDetails.icon}</div>
                                   <div class="widget-text">
                                       <h4>${momentDetails.title}</h4>
                                       <p>Suggested Time: <strong>${momentDetails.timeOfDay}</strong></p>
                                   </div>
                               </a>`;
                           }).join('')}
                        </div>
                    </div>
                </div>
            </section>`;
    } else {
         todaysPlanHtml = `
            <section id="todays-plan-section" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header"><h2 class="section-title">Today's Plan</h2></div>
                <div class="section-content" style="text-align:center; color: var(--text-secondary);">
                    <p>A day to explore! Check out the "Places" tab for ideas on what to see and do in ${city.name}.</p>
                </div>
            </section>`;
    }

    return `
        <div class="hero-card">
            <h2 class="hero-title">📍 Today in ${city.name}</h2>
            <p class="hero-subtitle">Here's what you need to know right now.</p>
        </div>
        <div class="content-grid">
            <div class="content-section animate-on-scroll">
                <div class="widget" style="cursor:pointer; padding: 20px;" id="weather-widget-today">
                    <h3>Live Weather</h3>
                    <div class="weather-main"><div class="weather-icon">⏳</div><div><div class="weather-temp">--°C</div><div class="weather-desc">Loading...</div></div></div>
                    <div class="weather-explainer">Click for forecast</div>
                </div>
            </div>
            ${todaysPlanHtml}
            <section class="content-section animate-on-scroll grid-span-2" id="ai-food-concierge">
                <div class="section-header">
                    <h2 class="section-title">What's Good Now?</h2>
                    <p class="section-subtitle" id="ai-food-subtitle"></p>
                </div>
                <div class="section-content">
                    <div class="widget" style="padding:0; border:none; box-shadow:none;">
                        <div class="widget-list" id="ai-food-recommendations"></div>
                    </div>
                </div>
            </section>
            <section id="live-intelligence-section" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header">
                    <h2 class="section-title">Live Travel Intelligence</h2>
                    <p class="section-subtitle">Your real-time destination pulse</p>
                </div>
                <div class="section-content">
                    <div class="intelligence-list" id="intelligence-list"></div>
                </div>
            </section>
        </div>
    `;
}


function renderPostTripView() {
    return `
        <div class="hero-card">
            <h2 class="hero-title">Adventure Complete!</h2>
            <p class="hero-subtitle">Hope you had an incredible time. Until the next one!</p>
        </div>
        <div class="content-grid">
           <section id="spotify-widget-section-post" class="content-section animate-on-scroll grid-span-2">
                <div class="section-header">
                    <h2 class="section-title">Relive The Moments</h2>
                    <p class="section-subtitle">The official playlist for the road.</p>
                </div>
                <div class="section-content">
                    <iframe data-testid="embed-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/playlist/4swp2D7X1f6b2GqZiCuzPu?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                </div>
            </section>
        </div>
    `;
}

function switchTabs(tabName, cityId = null) {
    const tabButton = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    if (tabButton) {
        tabButton.click();
        if (cityId) {
            setTimeout(() => {
                const cityTab = document.querySelector(`#tabs .tab[data-city="${cityId}"]`);
                if(cityTab) cityTab.click();
            }, 100);
        }
    }
}
function cloneAndSetupPlanner() {
    const originalTrack = document.getElementById('tip-track');
    const newTrack = document.getElementById('tip-track-today');
    const newDots = document.getElementById('planner-dots-today');
    const newCarousel = document.getElementById('tip-carousel-today');

    if (originalTrack && newTrack && newDots && newCarousel) {
        newTrack.innerHTML = originalTrack.innerHTML;
        setupTripPlanner('today'); // Pass suffix
    }
}


/* ========== CORE UI & LAYOUT (ORIGINAL FUNCTIONS) ========== */
function getCurrentTime() {
    // return debugDate || new Date();
    return new Date();
}

function setupCountdown() {
    const countdownInterval = setInterval(() => {
        const diff = TRIP_START_DATE.getTime() - getCurrentTime().getTime();
        if (diff <= 0) {
            const container = document.querySelector('.countdown-container');
            if(container) container.innerHTML = `<div style="font-size:18px;font-weight:600;color:var(--success);">🎉 Adventure Time!</div>`;
            clearInterval(countdownInterval);
            return;
        }
        const daysEl = document.getElementById('days');
        if(daysEl) daysEl.textContent = String(Math.floor(diff / 864e5)).padStart(2,'0');
        const hoursEl = document.getElementById('hours');
        if(hoursEl) hoursEl.textContent = String(Math.floor((diff % 864e5) / 36e5)).padStart(2,'0');
        const minutesEl = document.getElementById('minutes');
        if(minutesEl) minutesEl.textContent = String(Math.floor((diff % 36e5) / 6e4)).padStart(2,'0');
        const secondsEl = document.getElementById('seconds');
        if(secondsEl) secondsEl.textContent = String(Math.floor((diff % 6e4) / 1e3)).padStart(2,'0');
    }, 1000);
}


function updateTimelineStatus(){
    const el = document.getElementById('timelineStatus');
    if(!el) return;

    const diff = TRIP_START_DATE.getTime() - getCurrentTime().getTime();

    if (diff <= 0) {
        el.textContent = `🛤️ You're on the road — make it count!`;
        return;
    }

    const days = Math.floor(diff / 86400000);

    if (days > 0) {
        el.textContent = `🛤️ ~${days} day${days !== 1 ? 's' : ''} until your journey begins!`;
    } else {
        el.textContent = `🚀 Departs in less than a day!`;
    }
}


function updateRealProgress(){
  const road = document.querySelector('.route66__road');
  const dot  = document.querySelector('.route66__progress');
  if (!road || !dot) return;

  const roadStyle = window.getComputedStyle(road);
  const roadLeftOffset = parseFloat(roadStyle.left);
  const roadWidth = road.getBoundingClientRect().width;
  
  const tripStart = new Date(stops[0].start);
  const tripEnd = new Date(stops.at(-1).end);
  const now = getCurrentTime();
  
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const ratio = clamp((now - tripStart) / (tripEnd - tripStart), 0, 1);
  const newLeft = roadLeftOffset + (roadWidth * ratio);
  
  dot.style.left = `${newLeft}px`;
}

function observeScrollAnimations() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
    }, { threshold: 0.1 });
    document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
}
function setupTripPlanner(suffix = '') {
    const carouselId = suffix ? `tip-carousel-${suffix}` : 'tip-carousel';
    const trackId = suffix ? `tip-track-${suffix}` : 'tip-track';
    const dotsId = suffix ? `planner-dots-${suffix}` : 'planner-dots';
    
    const carousel = document.getElementById(carouselId);
    const track = document.getElementById(trackId);
    const dotsContainer = document.getElementById(dotsId);
    if (!track || !dotsContainer || !carousel) return;
    dotsContainer.innerHTML = ''; // Clear existing dots

    const slides = Array.from(track.children);
    const numSlides = slides.length;
    let currentIndex = 0;
    let autoPlayInterval;

    const goToSlide = (index) => {
        currentIndex = (index + numSlides) % numSlides;
        track.style.transform = `translateX(-${currentIndex * 100}%)`;
        dots.forEach((d, i) => d.classList.toggle('active', i === currentIndex));
    };

    const startAutoPlay = () => {
      clearInterval(autoPlayInterval);
      autoPlayInterval = setInterval(() => goToSlide(currentIndex + 1), 5000);
    };

    slides.forEach((_, i) => {
        const dot = document.createElement('button');
        dot.classList.add('dot');
        if (i === 0) dot.classList.add('active');
        dot.setAttribute('aria-label', `Go to tip ${i + 1}`);
        dot.addEventListener('click', () => {
            goToSlide(i);
            startAutoPlay();
        });
        dotsContainer.appendChild(dot);
    });

    const dots = Array.from(dotsContainer.children);

    let touchStartX = 0;
    carousel.addEventListener('touchstart', e => {
        touchStartX = e.touches[0].clientX;
        clearInterval(autoPlayInterval);
    }, { passive: true });

    carousel.addEventListener('touchend', e => {
        const touchEndX = e.changedTouches[0].clientX;
        const swipeDiff = touchStartX - touchEndX;
        if (Math.abs(swipeDiff) > 50) {
            goToSlide(currentIndex + (swipeDiff > 0 ? 1 : -1));
        }
        startAutoPlay();
    }, { passive: true });

    startAutoPlay();
}
async function fetchCurrencyRate() {
    try {
        const response = await fetch('https://api.frankfurter.app/latest?from=GBP&to=USD');
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        currentUSDRate = data.rates.USD;

        document.getElementById('currency-rate').textContent = `£1 = $${currentUSDRate.toFixed(4)}`;
        document.getElementById('currency-rate-sub').textContent = `Live Rate (Updated: ${data.date})`;

        document.getElementById('currency-input').addEventListener('input', (e) => updateCurrencyConversion(e.target.value));
        document.querySelectorAll('.quick-convert-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const amount = btn.dataset.amount;
                document.getElementById('currency-input').value = amount;
                updateCurrencyConversion(amount);
            });
        });

        renderCurrencyChart();

    } catch (error) {
        console.error('Failed to fetch currency rate:', error);
        document.getElementById('currency-rate').textContent = '£1 = $--.--';
        document.getElementById('currency-rate-sub').textContent = 'Could not fetch live rate.';
    }
}
function updateCurrencyConversion(amount) {
const resultEl = document.getElementById('conversion-result');
if (currentUSDRate && amount) {
const amountGBP = parseFloat(amount);
const amountUSD = (amountGBP * currentUSDRate).toFixed(2);
resultEl.textContent = `≈ $${amountUSD}`;
resultEl.classList.add('visible');
} else {
resultEl.classList.remove('visible');
}
}
function renderCurrencyChart() {
let d = "M0,40";
for (let i = 1; i <= 10; i++) {
const x = i * 30;
const y = 20 + Math.random() * 40;
d += ` L${x},${y}`;
}
document.getElementById('sparkline-path').setAttribute('d', d);
}
function buildTabsForPlaces() {
const container = document.getElementById('tabs');
container.innerHTML = Object.keys(cities).map((id, i) =>
`<button role="tab" aria-selected="${i===0}" class="tab ${i===0?'active':''}" data-city="${id}">${cities[id].name}</button>`
).join('');
container.addEventListener('click', e => { if (e.target.matches('.tab')) switchCity(e.target.dataset.city); });
}
function switchCity(cityId, isInitial = false) {
    currentCityId = cityId; // Update the global state
    const city = cities[cityId];
    const card = document.getElementById('main-card');
    const updateContent = () => {
        document.getElementById('hero-image').style.backgroundImage = `url('${city.hero}')`;
        document.getElementById('hero-title-text').textContent = city.name;
        document.getElementById('hero-area').textContent = city.area;
        
        const foodHtml = city.foodRecommendations ? `<div class="widget"><h3>Good Food Spots</h3><div class="widget-list">${Object.values(city.foodRecommendations).flat().slice(0, 3).map(item => `<a class="widget-item a" href="${item.url}" target="_blank" rel="noopener"><div class="widget-icon">${item.icon}</div><div class="widget-text"><h4>${item.name} ${item.veg ? '<span style="color:var(--success);font-size:12px;">🌱</span>' : ''}</h4><p>${item.desc}</p></div></a>`).join('')}</div></div>` : '';
        
        document.getElementById('content-column').innerHTML = `
            <div style="background:var(--surface);padding:16px;border-radius:var(--radius-lg);">
                <div class="info-item"><span>Dates</span><span>${city.dates}</span></div>
                <div class="info-item"><span>Stay</span><span>${city.stay.address}</span></div>
            </div>
            <div class="widget" style="cursor:pointer;" id="weather-widget">
                <h3>Live Weather</h3>
                <div class="weather-main"><div class="weather-icon">⏳</div><div><div class="weather-temp">--°C</div><div class="weather-desc">Loading...</div></div></div>
                <div class="weather-explainer">Click for forecast</div>
            </div>
            ${foodHtml}
        `;
        
        renderWeather(cityId, 'weather-widget');
        renderDynamicSectionsForPlaces(cityId); // A specific renderer for this tab
        document.querySelectorAll('#tabs .tab').forEach(t => {
            const isActive = t.dataset.city === cityId;
            t.classList.toggle('active', isActive);
            t.setAttribute('aria-selected', isActive);
        });
        card.classList.add('visible');
    };
    if (isInitial) {
        updateContent();
    } else {
        card.classList.remove('visible');
        setTimeout(updateContent, 300);
    }
}
function renderDynamicSectionsForPlaces(cityId) {
    const momentsSection = document.getElementById('dynamic-moments-section');
    const momentsGrid = document.getElementById('dynamic-moments-grid');
    
    // Find all moments that belong to this city
    const cityMoments = Object.entries(momentData)
        .filter(([id, data]) => data.cityId === cityId)
        .map(([id, data]) => ({ id, ...data }));

    if (cityMoments.length > 0) {
        momentsSection.style.display = 'block';
        momentsGrid.innerHTML = cityMoments.map(moment => `
            <article class="moment-card" onclick="openCustomModal('${moment.id}')">
                <div class="moment-header">
                    <div class="moment-icon">${moment.icon}</div>
                    <h3 class="moment-title">${moment.title}</h3>
                </div>
                <p class="moment-description">${moment.description}</p>
            </article>
        `).join('');
    } else {
        momentsSection.style.display = 'none';
    }
}


/* ========== AI FOOD CONCIERGE ========== */
function getCurrentCityOnTrip() {
    const now = getCurrentTime();
    for (const stop of stops) {
        const start = new Date(stop.start);
        const end = new Date(stop.end);
        end.setHours(23, 59, 59, 999);
        if (now >= start && now <= end) {
            return { id: stop.id, data: cities[stop.id] };
        }
    }
    return null;
}

function getTodaysTravel() {
    const now = getCurrentTime();
    const todayStr = now.toISOString().split('T')[0];

    const allFlights = Object.values(cities).flatMap(c => c.flights || []);
    const todaysFlight = allFlights.find(f => new Date(f.departureTime).toISOString().startsWith(todayStr));
    if (todaysFlight) return { type: 'flight', data: todaysFlight };

    const allDrives = [cities.yosemite.driveInfo, cities.vegas.driveInfo].filter(Boolean);
    const todaysDrive = allDrives.find(d => d.date === todayStr);
    if(todaysDrive) return { type: 'drive', data: todaysDrive };
    
    return null;
}

function updateFoodConcierge(cityId) {
    const conciergeSection = document.getElementById('ai-food-concierge');
    if (!conciergeSection) return;
    const subtitleEl = document.getElementById('ai-food-subtitle');
    const recommendationsList = document.getElementById('ai-food-recommendations');
    
    const cityInfo = cities[cityId];
    if (!cityInfo) {
        conciergeSection.style.display = 'none';
        return;
    }

    const now = getCurrentTime();
    const cityTimezone = cityInfo.timezone;
    const timeInCity = new Date(now.toLocaleString('en-US', { timeZone: cityTimezone }));
    const currentHour = timeInCity.getHours();
    
    let mealType = null;
    let mealIcon = '';
    let isLateNight = false;

    if (currentHour >= 7 && currentHour < 12) { mealType = 'breakfast'; mealIcon = '🍳'; }
    else if (currentHour >= 12 && currentHour < 17) { mealType = 'lunch'; mealIcon = '🍔'; }
    else if (currentHour >= 17 && currentHour < 22) { mealType = 'dinner'; mealIcon = '🌙'; }
    else { isLateNight = true; mealIcon = '🦉'; }

    const cityFoodData = cityInfo.foodRecommendations;
    if (!cityFoodData) {
        conciergeSection.style.display = 'none';
        return;
    }

    const anytimeRecommendations = cityFoodData.anytime || [];
    let mealRecommendations = [];
    let finalRecommendations = [];

    if (mealType && cityFoodData[mealType]) {
        mealRecommendations = cityFoodData[mealType];
        finalRecommendations = [...mealRecommendations, ...anytimeRecommendations];
        subtitleEl.textContent = `${mealIcon} Here are some ${mealType} spots in ${cityInfo.name}:`;
    } else if (isLateNight) {
        finalRecommendations = anytimeRecommendations;
        subtitleEl.textContent = `${mealIcon} Late night? Here are some spots open now in ${cityInfo.name}:`;
    }

    if (finalRecommendations.length > 0) {
        conciergeSection.style.display = 'block';
        recommendationsList.innerHTML = finalRecommendations.slice(0, 4).map(item =>
            `<a class="widget-item a" href="${item.url}" target="_blank" rel="noopener">
                <div class="widget-icon">${item.icon}</div>
                <div class="widget-text">
                    <h4>${item.name} ${item.veg ? '<span style="color:var(--success);font-size:12px;">🌱</span>' : ''}</h4>
                    <p>${item.desc}</p>
                </div>
            </a>`
        ).join('');
    } else {
        conciergeSection.style.display = 'none';
    }
}


async function renderLiveIntelligence(cityId) {
    const listContainer = document.getElementById('intelligence-list');
    if (!listContainer) return;
    listContainer.innerHTML = '<div class="placeholder">📡 Fetching your destination pulse...</div>';

    const cityIntelPromise = generateIntelligenceCards(cityId);
    const sportsIntelPromise = getSportsNews();

    try {
        const [cityCards, sportsCards] = await Promise.all([cityIntelPromise, sportsIntelPromise]);
        
        const allCards = [...cityCards, ...sportsCards];
        const uniqueTitles = new Set();
        const finalCards = allCards.filter(card => {
            if (!uniqueTitles.has(card.title)) {
                uniqueTitles.add(card.title);
                return true;
            }
            return false;
        }).slice(0, 3);

        displayIntelligence(finalCards);

    } catch (error) {
        console.error("Failed to render live intelligence:", error);
        listContainer.innerHTML = '<div class="placeholder">⚠️ Could not load live data. Please try again later.</div>';
    }
}

async function getDestinationNews() {
    const newsFeeds = {
        '🌉': { url: 'https://www.sfgate.com/bayarea/feed/', keywords: [] },
        '🎰': { url: 'https://www.ktnv.com/news.rss', keywords: [] },
        '🗽': { url: 'https://gothamist.com/feed/', keywords: [] }
    };

    let newsItems = [];
    for (const [icon, feed] of Object.entries(newsFeeds)) {
        const items = await fetchRSS(feed.url, feed.keywords);
        if (items.length > 0) {
            newsItems.push({ ...items[0], icon: icon, type: 'briefing' });
        }
    }
    return newsItems;
}

async function renderPreTripIntelligence() {
    const listContainer = document.getElementById('intelligence-list');
    if (!listContainer) return;
    listContainer.innerHTML = '<div class="placeholder">📡 Gathering your pre-trip briefing...</div>';

    try {
        const sportsPromise = getSportsNews();
        const newsPromise = getDestinationNews();

        const [sportsCards, newsCards] = await Promise.all([sportsPromise, newsPromise]);
        
        const planningCard = {
            type: 'briefing',
            icon: '🎟️',
            title: 'Book in Advance!',
            desc: "Popular attractions like Alcatraz can sell out weeks ahead. Check your itinerary and book any must-do tickets now to avoid disappointment.",
            source: 'AI Assistant',
            link: '#'
        };

        const allCards = [planningCard, ...sportsCards, ...newsCards];
        
        const uniqueTitles = new Set();
        const finalCards = allCards.filter(card => {
            if (!uniqueTitles.has(card.title)) {
                uniqueTitles.add(card.title);
                return true;
            }
            return false;
        }).slice(0, 4); 

        displayIntelligence(finalCards);

    } catch (error) {
        console.error("Failed to render pre-trip intelligence:", error);
        listContainer.innerHTML = '<div class="placeholder">⚠️ Could not load live briefing.</div>';
    }
}


function displayIntelligence(cards) {
    const listContainer = document.getElementById('intelligence-list');
    if (!listContainer) return;
    if (!cards || cards.length === 0) {
        listContainer.innerHTML = '<div class="placeholder">All clear! No critical updates right now.</div>';
        return;
    }

    listContainer.innerHTML = cards.map(item => {
        return `
            <a href="${item.link || '#'}" target="_blank" rel="noopener" class="intelligence-card ${item.type || ''}">
                <div class="icon">${item.icon}</div>
                <div class="content">
                    <h4>${item.title}</h4>
                    <p>${item.desc}</p>
                    <div class="meta">Source: ${item.source} • Live</div>
                </div>
            </a>
        `;
    }).join('');
}


/* ========== INTERACTIVITY HOOKS FOR NEW MAP ========== */
function showLocationDetails(cityId) {
    switchTabs('places', cityId);
}
function showMomentDetails(momentId) {
openCustomModal(momentId);
}

/* ========== JOURNEY HUB LOGIC ========== */
function getFlightById(flightId) {
for (const cityId in cities) {
const flight = cities[cityId].flights?.find(f => f.id === flightId);
if (flight) return { flight, city: cities[cityId] };
}
return null;
}
function getDestinationCityByFlight(flight) {
    const destinationCode = flight.route.split(' → ')[1].trim();
    const cityMap = { SFO: 'sanfran', LAS: 'vegas', JFK: 'nyc' };
    for (const code in cityMap) {
        if (destinationCode.includes(code)) {
            return cities[cityMap[code]];
        }
    }
    return null;
}
function formatTimeDiff(diffMs) {
diffMs = Math.max(0, diffMs);
const h = Math.floor(diffMs / 36e5), m = Math.floor((diffMs % 36e5) / 6e4), s = Math.floor((diffMs % 6e4) / 1e3);
return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
}

function updateJourneyHub() {
    const now = getCurrentTime();
    
    const journeyList = document.getElementById('dynamic-flights-list');
    if (journeyList) {
        const allFlights = Object.values(cities).flatMap(c => c.flights || []).sort((a,b) => new Date(a.departureTime) - new Date(b.departureTime));
        const allDrives = [cities.yosemite.driveInfo, cities.vegas.driveInfo].filter(Boolean).sort((a,b) => new Date(a.date) - new Date(b.date));
        const allTravel = [...allFlights.map(f => ({...f, type: 'flight'})), ...allDrives.map(d => ({...d, type: 'drive'}))];
        allTravel.sort((a, b) => new Date(a.departureTime || a.date) - new Date(b.departureTime || b.date));

        let html = '';
        allTravel.forEach(item => {
            if (item.type === 'flight') {
                html += `<div class="flight-container" id="${item.id}"></div>`;
            } else {
                const fromCityName = item.from;
                const toCityName = item.to;
                const routeMap = { "San Francisco": "SFO", "Yosemite": "YOS", "Las Vegas": "LAS" };
                const fromCode = routeMap[fromCityName] || fromCityName.substring(0,3).toUpperCase();
                const toCode = routeMap[toCityName] || toCityName.substring(0,3).toUpperCase();
                let formattedDate = new Date(item.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                html += `
                <article class="drive-card">
                    <div class="drive-card-content">
                        <div class="flight-header">
                            <div class="flight-route">🚗 ${fromCode} → ${toCode}</div>
                            <div class="flight-date">${formattedDate}</div>
                        </div>
                        <div class="flight-details">
                            <div><div class="detail-label">Est. Duration</div><div class="detail-value">${item.duration}</div></div>
                            <div><div class="detail-label">Mode</div><div class="detail-value" style="display:flex; align-items:center; gap: 6px;"><span>By Car</span><a href="${item.mapsLink}" target="_blank" rel="noopener" style="font-size:12px; font-weight: 500;">Maps</a></div></div>
                        </div>
                        <div class="drive-fact">${item.fact}</div>
                    </div>
                </article>`;
            }
        });
        journeyList.innerHTML = html;
    }


    // Now populate the flight containers with dynamic data
    document.querySelectorAll('.flight-container').forEach(cardEl => {
        const flightData = getFlightById(cardEl.id);
        if (!flightData) return;

        const { flight } = flightData;
        const departureTime = new Date(flight.departureTime);
        const arrivalTime = new Date(flight.arrivalTime);
        const hoursUntilDeparture = (departureTime - now) / 3600000;
        const destinationCity = getDestinationCityByFlight(flight);

        let currentState = 'default';
         if (now > arrivalTime) {
            currentState = (now - arrivalTime) > (24 * 3600000 * 2) ? 'archived' : 'post-flight';
        } else if (now >= departureTime && now <= arrivalTime) {
             currentState = 'in-flight';
        } else if (hoursUntilDeparture <= 6) {
            currentState = 'pre-flight';
        } else if (hoursUntilDeparture <= 24) {
            currentState = 'get-ready';
        }

        let summaryCardClass = "flight-summary-card";
        let summaryContent = `<div class="flight-header"><div class="flight-route">${flight.route}</div><div class="flight-date">${new Date(flight.departureTime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div></div><div class="flight-details"><div><div class="detail-label">Flight</div><div class="detail-value">${flight.airline} ${flight.number}</div></div><div><div class="detail-label">Duration</div><div class="detail-value">${flight.duration}</div></div><div><div class="detail-label">Status</div><div class="detail-value">Click to View</div></div></div>`;
        let extraContent = '';

        if(currentState === 'get-ready') {
            summaryCardClass += ' get-ready';
            extraContent = `<div class="journey-actions"><a href="${flight.checkinURL}" target="_blank" rel="noopener" class="journey-btn primary" onclick="event.stopPropagation()">✈️ Online Check-In</a></div>`;
        } else if (currentState === 'pre-flight' || currentState === 'in-flight') {
            summaryCardClass += ' travel-day';
            summaryContent = `<div class="flight-header"><div class="flight-route">${flight.route}</div></div><div class="journey-countdown"><div class="countdown-title">${currentState === 'in-flight' ? 'IN-FLIGHT' : 'DEPARTS IN'}</div><div class="countdown-time">${currentState === 'in-flight' ? 'Bon Voyage!' : formatTimeDiff(departureTime - now)}</div></div>`;
            extraContent = `<div class="journey-actions"><a href="#" class="journey-btn" onclick="event.stopPropagation(); openFlightModal('${flight.id}');">📄 Boarding Pass</a><a href="https://www.google.com/maps/dir/?api=1&destination=${flight.route.split('→')[0].trim()}+Airport" target="_blank" class="journey-btn">🚗 To Airport</a></div>`;
        } else if(currentState === 'post-flight' && destinationCity){
             cardEl.innerHTML = `<article class="flight-summary-card travel-day"><div class="flight-summary-content handoff-welcome"><div class="handoff-title">Welcome to ${destinationCity.name}!</div><div class="handoff-subtitle">Your adventure continues.</div></div><div class="handoff-address"><strong>Your Next Stay</strong><span>${destinationCity.stay.address}</span></div><div style="padding: 0 20px 16px;"><a href="${destinationCity.stay.mapsLink}" target="_blank" rel="noopener" class="journey-btn primary">🗺️ Navigate to Your Stay</a></div></article>`;
             return;
        } else if(currentState === 'archived') {
            cardEl.innerHTML = `<article class="flight-summary-card archived"><div class="flight-summary-content" style="opacity: 0.7;"><div class="flight-header"><div class="flight-route">✅ ${flight.route}</div><div class="flight-date">${new Date(flight.departureTime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div></div><div style="font-size: 14px; color: var(--text-secondary); padding-top: 8px;">Journey complete.</div></div></article>`;
            return;
        }

        cardEl.innerHTML = `<article class="${summaryCardClass}" onclick="openFlightModal('${flight.id}')"><div class="flight-summary-content">${summaryContent}</div>${extraContent ? `<div class="flight-summary-content" style="padding-top:0;">${extraContent}</div>` : ''}</article>`;
    });
}


function openFlightModal(flightId) {
    const flightData = getFlightById(flightId);
    if (!flightData) return;
    const { flight } = flightData;
    
    const colors = airlineColors[flight.airline] || airlineColors['default'];
    const [fromCode, toCode] = flight.route.split(' → ');
    const fromCity = Object.values(cities).find(c => c.flights && c.flights.some(f=> f.id === flight.id))?.name || 'Origin';
    const toCity = getDestinationCityByFlight(flight)?.name || 'Destination';

    const dep = new Date(flight.departureTime);
    const arr = new Date(flight.arrivalTime);
    const boardingTime = new Date(dep.getTime() - 45 * 60000);

    const formatTime = (date) => date.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false});

    const modalContent = `
      <header style="background: linear-gradient(to bottom, ${colors.primary}, ${colors.secondary});">
        <div class="logo" style="color:${colors.text}">${flight.airline}</div>
        <div class="flight">
          <small>flight</small>
          <strong>${flight.number}</strong>
        </div>
      </header>
      <section class="cities">
        <div class="city">
          <small>${fromCity}</small>
          <strong>${fromCode}</strong>
        </div>
        <div class="city">
          <small>${toCity}</small>
          <strong>${toCode}</strong>
        </div>
        <svg class="airplane">
          <use xlink:href="#airplane"></use>
        </svg>
      </section>
      <section class="infos">
        <div class="places">
          <div class="box">
            <small>Terminal</small>
            <strong>--</strong>
          </div>
          <div class="box">
            <small>Gate</small>
            <strong>--</strong>
          </div>
          <div class="box">
            <small>Seat</small>
            <strong>--</strong>
          </div>
          <div class="box">
            <small>Class</small>
            <strong>Y</strong>
          </div>
        </div>
        <div class="times">
          <div class="box">
            <small>Boarding</small>
            <strong>${formatTime(boardingTime)}</strong>
          </div>
          <div class="box">
            <small>Departure</small>
            <strong>${formatTime(dep)}</strong>
          </div>
          <div class="box">
            <small>Duration</small>
            <strong>${flight.duration}</strong>
          </div>
          <div class="box">
            <small>Arrival</small>
            <strong>${formatTime(arr)}</strong>
          </div>
        </div>
      </section>
      <section class="strap">
        <div class="box">
          <div class="passenger">
            <small>passenger</small>
            <strong>USA Adventurer</strong>
          </div>
          <div class="date">
            <small>Date</small>
            <strong>${dep.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})}</strong>
          </div>
        </div>
        <svg class="qrcode">
          <use xlink:href="#qrcode"></use>
        </svg>
      </section>
    `;
    
    document.getElementById('boarding-pass-content').innerHTML = modalContent;
    document.getElementById('boarding-pass-overlay').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeFlightModal() {
    document.getElementById('boarding-pass-overlay').classList.remove('show');
    document.body.style.overflow = '';
}


/* ========== WEATHER & MODALS ========== */

function toggleMapModal(show) {
    const overlay = document.getElementById('map-modal-overlay');
    if (show) {
        overlay.classList.add('show');
        document.body.style.overflow = 'hidden';
        if (!mapInitialized) {
            initMap();
        }
    } else {
        overlay.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function initMap() {
    map = L.map('map-container').setView([39.8283, -98.5795], 4);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    const latlngs = [];
    Object.keys(cities).forEach(cityId => {
        const city = cities[cityId];
        latlngs.push([city.lat, city.lon]);
        L.marker([city.lat, city.lon]).addTo(map)
            .bindPopup(`<b>${city.name}</b>`);
    });

    const polyline = L.polyline(latlngs, { color: 'var(--primary)', weight: 3 }).addTo(map);
    map.fitBounds(polyline.getBounds().pad(0.2));
    
    mapInitialized = true;
}


async function fetchWeather(city) {
const cache = weatherCache.get(city.name);
if (cache && (Date.now() - cache.ts) < 900000) return cache.data; // 15 min cache
const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,wind_speed_10m,precipitation_probability&hourly=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&windspeed_unit=kmh&timezone=auto&forecast_days=7`;
try {
const res = await fetch(url);
if (!res.ok) throw new Error("Weather API fetch failed");
const data = await res.json();
weatherCache.set(city.name, { data, ts: Date.now() });
return data;
} catch (e) { console.error("Weather fetch failed:", e); return null; }
}
async function renderWeather(cityId, widgetId) {
    const city = cities[cityId];
    const widget = document.getElementById(widgetId);
    if (!widget) return;
    const data = await fetchWeather(city);
    if (!data) { widget.querySelector('.weather-desc').textContent = "Failed to load"; return; }
    widget.querySelector('.weather-icon').textContent = wmoIcon(data.current.weather_code);
    widget.querySelector('.weather-temp').textContent = `${Math.round(data.current.temperature_2m)}°C`;
    widget.querySelector('.weather-desc').textContent = weatherDescriptions[data.current.weather_code] || 'Clear';
    widget.onclick = () => openWeatherDetail(city, data);
}

function openWeatherDetail(city, data) {
const { current, hourly, daily } = data;
const type = wmoAnimType(current.weather_code);
document.getElementById('wx-sheet').className = `wx-sheet wx-${type}`;
document.getElementById('wx-anim-detail').innerHTML = wmoAnimHTML(type);
document.getElementById('wx-city').textContent = city.name;
document.getElementById('wx-temp-lg').textContent = `${Math.round(current.temperature_2m)}°`;
document.getElementById('wx-desc-lg').textContent = weatherDescriptions[current.weather_code] || 'Clear';
document.getElementById('wx-feels').textContent = `${Math.round(current.apparent_temperature)}°`;
document.getElementById('wx-hum').textContent = `${current.relative_humidity_2m}%`;
document.getElementById('wx-wind').textContent = `${Math.round(current.wind_speed_10m)} km/h`;
document.getElementById('wx-rain').textContent = `${current.precipitation_probability || 0}%`;
const now = getCurrentTime();
const startIndex = hourly.time.findIndex(t => new Date(t) > now);
document.getElementById('wx-hourly-cards').innerHTML = hourly.time.slice(startIndex, startIndex + 8).map((time, i) => `<div class="wx-hour"><div>${new Date(time).getHours()}:00</div><div style="font-size:22px;margin:4px 0">${wmoIcon(hourly.weather_code[startIndex+i])}</div><div class="t">${Math.round(hourly.temperature_2m[startIndex+i])}°</div></div>`).join('');
document.getElementById('wx-days-cards').innerHTML = daily.time.slice(1, 4).map((date, i) => `<div class="wx-day"><div>${new Date(date).toLocaleDateString('en-US', {weekday:'short'})}</div><div style="font-size:22px;margin:6px 0">${wmoIcon(daily.weather_code[i+1])}</div><div><span class="hi">${Math.round(daily.temperature_2m_max[i+1])}°</span>/<span class="lo">${Math.round(daily.temperature_2m_min[i+1])}°</span></div></div>`).join('');
toggleWx(true);
}
function toggleWx(open) {
document.getElementById('wx-overlay').classList.toggle('show', open);
document.body.style.overflow = open ? 'hidden' : '';
}

function toggleConcierge() {
    const overlay = document.getElementById('concierge-overlay');
    const isOpen = overlay.classList.contains('show');
    if (!isOpen) {
        let cityToShowId;
        const activeTabId = document.querySelector('.tab-content.active').id;
        if (activeTabId === 'tab-today') {
            const currentTripCity = getCurrentCityOnTrip();
            cityToShowId = currentTripCity ? currentTripCity.id : 'sanfran'; // Default if not in a city
        } else {
            cityToShowId = currentCityId; // Use the city from the Places tab
        }

        const city = cities[cityToShowId];
        if (city && city.concierge) {
            document.getElementById('concierge-title').textContent = `${city.name} Concierge`;
            document.getElementById('quick-actions').innerHTML = city.concierge.map(a => `<a class="quick-action" href="${a.url}" target="_blank" rel="noopener"><div class="icon">${a.icon}</div><div class="label">${a.label}</div></a>`).join('');
        }
    }
    overlay.classList.toggle('show');
    document.body.style.overflow = isOpen ? '' : 'hidden';
}

function getCityIdForMoment(momentId) {
    return momentData[momentId]?.cityId || null;
}
async function openCustomModal(id) {
const data = momentData[id];
if(!data) return;

const cityId = getCityIdForMoment(id);
const city = cities[cityId];
if(!city) return;

document.getElementById('modalTitleCustom').textContent = data.title;
let bodyHTML = `
<p style="color:var(--text-secondary); line-height:1.6; margin-bottom: 24px;">${data.description}</p>
<h4 style="font-size: 16px; font-weight: 600; margin-bottom:12px;">📍 Key Locations & Notes</h4>
${data.locations.map(loc => `<div class="modal-list-item"><div class="modal-item-text"><strong>${loc.name}</strong><span>${loc.why}</span></div><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.name)}" target="_blank" class="modal-item-action">Map</a></div>`).join('')}
<div id="live-tips-container"></div>`;
document.getElementById('modalBodyCustom').innerHTML = bodyHTML;
document.getElementById('modalOverlayCustom').classList.add('show');
document.body.style.overflow = 'hidden';

const tipsContainer = document.getElementById('live-tips-container');
tipsContainer.innerHTML = '<div class="live-tip">Analysing live conditions...</div>';

const weatherData = await fetchWeather(city);
if (weatherData && data.tips) {
const current = weatherData.current;
const liveTips = data.tips.filter(tip => {
if (!tip.condition) return true;
const codeMatch = tip.condition.code && tip.condition.code.includes(current.weather_code);
const tempMatch = tip.condition.temp_gt && current.temperature_2m > tip.condition.temp_gt;
return codeMatch || tempMatch;
});
if(liveTips.length > 0) {
const liveTipsHtml = `<h4 style="font-size: 16px; font-weight: 600; margin-top:24px; margin-bottom:12px;">💡 Live Tips</h4>` +
liveTips.map(tip => `<div class="live-tip">${tip.text}</div>`).join('');
tipsContainer.innerHTML = liveTipsHtml;
} else {
tipsContainer.innerHTML = '';
}
} else {
tipsContainer.innerHTML = '';
}
}
function closeCustomModal() {
document.getElementById('modalOverlayCustom').classList.remove('show');
document.body.style.overflow = '';
}

/* ========== BIRTHDAY & SLOT MACHINE ========== */
const slotSymbols = ['💎', '🍒', '7️⃣', '🎰', '🔔'];
let isSpinning = false;

function playSlots() {
if (isSpinning) return;
isSpinning = true;
const container = document.getElementById('slotMachineContainer');
container.classList.add('visible');
const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
const results = reels.map(() => slotSymbols[Math.floor(Math.random() * slotSymbols.length)]);

reels.forEach((reel, i) => {
const strip = Array.from({ length: 30 }, () => slotSymbols[Math.floor(Math.random() * slotSymbols.length)]);
strip[strip.length - 2] = results[i];
reel.innerHTML = strip.map(symbol => `<span>${symbol}</span>`).join('');

reel.style.transition = 'none';
reel.style.transform = 'translateY(0)';
void reel.offsetHeight; // Force reflow

const finalPosition = (strip.length - 2) * 100;
reel.style.transition = `transform ${2500 + i * 500}ms cubic-bezier(0.25, 0.1, 0.25, 1)`;
reel.style.transform = `translateY(-${finalPosition}px)`;
});

setTimeout(() => {
const isWin = results[0] === results[1] && results[1] === results[2];
if (isWin) {
celebrateBirthday();
} else {
const wittyLossMessages = [
"Almost! The house always has an edge.",
"Not quite! Maybe try blowing on the screen first?",
"So close! Are you sure you're feeling lucky?",
"Swing and a miss! The slots are fickle.",
"Better luck next time! Vegas wasn't built in a day.",
"That's not it. Try channeling your inner high-roller."
];
const randomMessage = wittyLossMessages[Math.floor(Math.random() * wittyLossMessages.length)];
showVegasToast('😂', randomMessage);
}
isSpinning = false;
}, 3500);
}

function celebrateBirthday() {
triggerJackpotConfetti();
showVegasToast('🎉', 'JACKPOT! Lets Win Even BIGGER in Vegas!');
if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
}

function triggerJackpotConfetti() {
const canvas = document.getElementById('vegasConfettiCanvas');
if (!canvas) return;
const ctx = canvas.getContext('2d');
canvas.width = canvas.parentElement.offsetWidth;
canvas.height = canvas.parentElement.offsetHeight;
const particles = [];
const colors = ['#FFD700', '#FF1493', '#00F5FF'];
const emojis = ['💰', '🎰', '💎', '🎉'];
for (let i = 0; i < 150; i++) particles.push({ x: canvas.width/2, y: canvas.height, vx: (Math.random()-0.5)*10, vy: -Math.random()*15-5, size: Math.random()>0.8?24:Math.random()*8+4, color: colors[Math.floor(Math.random()*colors.length)], emoji: Math.random()>0.8?emojis[Math.floor(Math.random()*emojis.length)]:null, opacity:1, gravity:0.2 });
function animateConfetti() {
ctx.clearRect(0, 0, canvas.width, canvas.height);
particles.forEach((p, i) => {
p.vy+=p.gravity; p.x+=p.vx; p.y+=p.vy; p.opacity-=0.005; ctx.globalAlpha=p.opacity;
if (p.emoji) { ctx.font=`${p.size}px Arial`; ctx.fillText(p.emoji,p.x,p.y); }
else { ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.size,p.size); }
if (p.opacity<=0) particles.splice(i,1);
});
if (particles.length > 0) requestAnimationFrame(animateConfetti);
}
animateConfetti();
}

function showVegasToast(icon, message) {
const existing = document.querySelector('.vegas-toast');
if(existing) existing.remove();
const toast = document.createElement('div');
toast.className = 'vegas-toast';
toast.innerHTML = `<span style="font-size:24px">${icon}</span><span>${message}</span>`;
document.body.appendChild(toast);
setTimeout(() => toast.classList.add('show'), 10);
setTimeout(() => {
toast.classList.remove('show');
toast.addEventListener('transitionend', () => toast.remove());
}, 3000);
}

/* ========== UTILITY MAPPING ========== */
const wmoIcon = (code) => ({0:"☀️",1:"🌤️",2:"⛅",3:"☁️",45:"🌫️",48:"🌫️",51:"🌦️",53:"🌦️",55:"🌦️",61:"🌦️",63:"🌧️",65:"🌧️",80:"🌧️",95:"⛈️"}[code] || "🌡️");
const wmoAnimType = (code) => ({0:"sunny",1:"cloudy",2:"cloudy",3:"cloudy",45:"cloudy",48:"cloudy",51:"rainy",53:"rainy",55:"rainy",61:"rainy",63:"rainy",65:"rainy",80:"rainy",95:"rainy"}[code] || "cloudy");
const wmoAnimHTML = (type) => type === "rainy" ? Array.from({length:32}).map(()=>`<div class="rain-drop" style="left:${Math.random()*100}%; top:${Math.random()*80}%; animation-delay:${(Math.random()*1.2).toFixed(2)}s; animation-duration:${(0.7+Math.random()*0.7).toFixed(2)}s"></div>`).join('') : "";
const weatherDescriptions = {0:"Clear",1:"Mainly Clear",2:"Partly Cloudy",3:"Overcast",45:"Fog",48:"Rime Fog",51:"Light Drizzle",53:"Drizzle",55:"Heavy Drizzle",61:"Slight Rain",63:"Rain",65:"Heavy Rain",80:"Showers",95:"Thunderstorm"};
</script>
</body>
</html>
